<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="contentScript">
    <script th:inline="javascript">
        let lastsel;
        let temp = {obligation: ''};
        let list = [];
        let licenseTags = [];
        let gLicenseData = new Array();
        let detectedLicenseValid = true;
        let deactivateFlag = "N";
        let renameFlag = "N";
        let nickNameClone;

        $(window).load(function () {
            oss_edit_data.init();

            commonAjax.getLicenseTags().success(function (data, status, headers, config) {
                if (data != null) {
                    data.forEach(function (obj) {
                        var tag = {
                            value: obj.licenseName,
                            licenseId: obj.licenseId,
                            label: obj.shortIdentifier.length > 0 ? obj.licenseName + ' (' + obj.shortIdentifier + ')' : obj.licenseName,
                            licenseName: obj.licenseName,
                            shortIdentifier: obj.shortIdentifier,
                            licenseType: obj.licenseType,
                            obligation: obj.obligation,
                            obligationChecks: obj.obligationChecks,
                            obligationCode: obj.obligationCode,
                            licenseTypeVal: obj.licenseTypeVal,
                            restriction: obj.restriction
                        }
                        licenseTags.push(tag);
                    });
                }
            });

            setCustomAutoComplete('single');
        });

        const oss_edit_data = {
            detail: [[ ${detail}]],
            list: [[ ${list}]] != null ? [[ ${list}]] : {rows: []},
            components: [[ ${components}]],
            componentsPartner: [[ ${componentsPartner}]],
            vulnInfoList: [[ ${vulnInfoList}]],
            clone: '',
            typeCodes: [],
            ossId: [[ ${ossId}]],
            isCopyData: [[ ${isCopyData} ]],
            init: function () {
                list = this.isCopyData ? this.detail.ossLicenses : this.list.rows;

                if (this.isCopyData) {
                    $('input[name=ossCopyFlag]').val("Y");
                } else if (this.ossId) {
                    oss_edit_cmt.getCommentList();
                }

                oss_edit_evt.init();
                oss_edit_grid.load();
            }
        }

        const oss_edit_evt = {
            init: function () {
                $('#licenseTypeSelect').select2({
                    placeholder: "License Type",
                    allowClear: true,
                });

                $("#restrictionSelect").select2({
                    placeholder: "Restriction",
                    allowClear: true,
                });

                $("[name='commentInput']").summernote({
                    height: 100,
                    callbacks: {
                        onInit: function() {
                            var content = $(this).summernote('code');
                            if (content === '<p><br></p>') {
                                $(this).summernote('code', '');
                            }
                        }
                    }
                });

                $("[name='addTagButton']").click(function (e) {
                    const elId = this.id;
                    appendSingleTag(e, elId);
                });

                //delete license
                $('#delete').on('click', function () {
                    var editorVal = $("#commentCont").summernote('code');

                    if (editorVal == "") {
                        alertify.alert(String([[#{msg.license.confirm.delete.required.comment}]]), function () {
                        });
                        return false;
                    }

                    alertify.confirm(String([[#{msg.license.confirm.delete}]]), function (e) {
                        if (e) {
                            $('input[name=comment]').val(editorVal);
                            deleteSubmit();
                        } else {
                            return false;
                        }
                    });
                });
            }
        }

        const oss_edit_grid = {
            load: function () {
                const _licenseChoice = $('#_licenseChoice');
                _licenseChoice.jqGrid({
                    datatype: 'local',
                    data: list,
                    colNames: ['', '', '', 'License', 'Copyright', '', '', '', '', 'license Type', 'obligationChecks'],
                    colModel: [
                        {name: 'no', index: 'ossLicenseIdx', width: 30, hidden: true},
                        {name: 'ossLicenseIdx', index: 'ossLicenseIdx', width: 30, key: true, hidden: true},
                        {
                            name: 'ossLicenseComb',
                            index: 'ossLicenseComb',
                            width: 70,
                            align: "center",
                            sortable: false,
                            editable: true,
                            edittype: "select",
                            editoptions: {value: "AND:AND;OR:OR", dataEvents: [{type: 'change', fn: changeLicenseType}]}
                        },
                        {
                            name: 'licenseNameEx', index: 'licenseNameEx', width: 150, editable: true, editoptions: {
                                dataInit: function (elem) {
                                    $(elem).focus(function () {
                                        setCustomAutoComplete('multi');
                                    })
                                }
                            }
                        },
                        {
                            name: 'ossCopyright',
                            index: 'ossCopyright',
                            width: 250,
                            editable: true,
                            edittype: "textarea",
                            editoptions: {rows: "10", cols: "50"}
                        },
                        {
                            name: 'delete',
                            index: 'delete',
                            width: 80,
                            align: 'center',
                            sortable: false,
                            formatter: oss_edit_fmt.displayButtons
                        },
                        {name: 'licenseName', index: 'licenseName', width: 50, hidden: true},
                        {name: 'licenseId', index: 'licenseId', width: 50, hidden: true},
                        {name: 'licenseNameEx', index: 'licenseNameOrg', width: 50, hidden: true},
                        {name: 'licenseType', index: 'licenseType', width: 50, hidden: true},
                        {name: 'obligationChecks', index: 'obligationChecks', width: 50, hidden: true}
                    ],
                    autoencode: true,
                    editurl: 'clientArray',
                    pager: '#_licenseChoicePager',
                    autowidth: true,
                    height: 'auto',
                    gridview: true,
                    rownumbers: true,
                    viewrecords: true,
                    loadonce: true,
                    onSelectRow: function (rowid) {
                        $("div.retxt._licenseChoice_" + rowid).remove();

                        if (rowid && rowid !== lastsel) {
                            _licenseChoice.jqGrid('saveRow', lastsel);
                            _licenseChoice.jqGrid('editRow', rowid);
                            lastsel = rowid;

                            createMultiLicenseText();

                            list.forEach(function (row, index) {
                                if (row.ossLicenseIdx == lastsel) {
                                    row.ossLicenseComb = $('#_licenseChoice').jqGrid('getCell', lastsel, 'ossLicenseComb');
                                }
                                ;
                            });

                            makeBackGroundColor();
                            setFristComb();
                            setCustomAutoComplete('multi');

                            var type = autoLicense(list);
                            var obligationHtml = autoObligation(list);

                            if (list.length == 0) {
                                type = '';
                                obligationHtml = '';
                            }

                            $('#lt td').html(type);
                            $('#ob td').html('');
                            $(obligationHtml).appendTo('#ob td');
                        }
                    },
                    afterInsertRow: function (rowid, rowdata, rowelem) {

                    },
                    loadComplete: function (data) {
                        lastsel = -1;
                        // hidePageNav('_licenseChoicePager');
                        setFristComb();
                        createMultiLicenseText();
                        makeBackGroundColor();

                        var type = autoLicense(list);
                        var obligationHtml = autoObligation(list);

                        if(list.length==0){
                            type='';
                            obligationHtml='';
                        }
                    }
                });

                _licenseChoice.jqGrid('navGrid', "#_licenseChoicePager", {
                    edit: false, add: true, del: false, search: false, refresh: false
                    , addfunc: function (rowid) {
                        var ids = $("#_licenseChoice").jqGrid("getDataIDs");
                        var newId = ids.length ? Number(ids[ids.length - 1]) + 1 : 1;
                        var row = {no: newId, ossLicenseIdx: newId};
                        oss_edit_data.list.rows.push(row);
                        $("#_licenseChoice").jqGrid("addRowData", newId, row, "last");
                        $("#_licenseChoice").jqGrid("setSelection", newId);

                        // 첫 로우 ossLicenseComb 설정
                        setFristComb();
                    }
                });
            }
        }

        const oss_edit_fn = {
            save: function () {
                if (oss_edit_fn.checkValid()) {
                    var licenseDiv = "";
                    var licenseChoiceLength = $("#_licenseChoice").jqGrid("getDataIDs").length;

                    switch (licenseChoiceLength) {
                        case 0:
                            alertify.alert(String([[ #{msg.oss.required.license}]]), function () {
                            });
                            return false;
                            break;
                        case 1:
                            $("input[name=licenseDiv]").val("S");
                            licenseDiv = "S";
                            break;
                        default:
                            $("input[name=licenseDiv]").val("M");
                            licenseDiv = "M";
                            break;
                    }

                    const rows = getOssGridRows('#_licenseChoice');
                    const dataIds = $('#_licenseChoice').jqGrid('getDataIDs');
                    const gridStr = "_licenseChoice";
                    let jsValidResult = true;

                    dataIds.forEach(function (dataId) {
                        var rowData = $('#_licenseChoice').jqGrid('getRowData', dataId);
                        var licenseName = rowData.licenseNameEx;

                        if (checkLicenseSelected(licenseName) == null) {
                            var errRow = $("#" + gridStr + " #" + dataId + " td[aria-describedby='" + gridStr + "_licenseNameEx']");

                            if (errRow) {
                                errRow.append('<div class=\"' + gridStr + "_" + dataId + ' retxt"\">' + String([[ #{msg.oss.unknown.license}]]) + '</div>');
                            }

                            $("div.retxt._licenseChoice_" + dataId).show();

                            jsValidResult = false;
                        }
                    });

                    if (!jsValidResult || !detectedLicenseValid) {
                        alertify.error(String([[ #{msg.common.valid}]]), 0);
                        //$("span.retxt").show();

                        return false;
                    }

                    const editorVal = $("#commentCont").summernote('code');
                    const localDeactivateFlag = $("[name='deactivateFlag']").val();

                    if (editorVal == "") {
                        if (deactivateFlag == "N"
                            && localDeactivateFlag == "Y") { // deactivate Flag checked
                            alertify.alert(String([[ #{msg.oss.required.deactivate}]]), function () {
                            });
                            return false;
                        }

                        if (deactivateFlag == "Y"
                            && localDeactivateFlag == "N") { // deactivate Flag unchecked
                            alertify.alert(String([[ #{msg.oss.required.activate}]]), function () {
                            });
                            return false;
                        }
                    }

                    alertify.confirm(String([[ #{msg.common.confirm.save}]]), function (e) {
                        if (e) {
                            $('#_licenseChoice').jqGrid('saveRow', lastsel);
                            registSubmit();
                        } else {
                            return false;
                        }
                    });
                }
            },
            checkValid: function () {
                var result = gLicenseData.filter(function (a) {
                    return a == "N";
                });

                if (result.length > 0) {
                    alertify.alert(String([[ #{msg.oss.required.auto}]]), function () {
                    });
                    return false;
                }
                return true;
            },
            checkNickName: function (target) {
                var targetVal = $(target).val();

                if (targetVal.indexOf(",") > -1) {
                    $(target).parent().next("span.retxt").html("Formatting error").show();
                } else {
                    $(target).parent().next("span.retxt").hide();
                }
            },
            syncOssPage : function () {
                const ossId = oss_edit_data.ossId;
                const ossNameInputValue = $("input[name=ossName]").val();
                const ossVersionInputValue = $("input[name=ossVersion]").val();

                if(ossNameInputValue != "") {
                    getAjaxJsonData({ossName : ossNameInputValue}, "/oss/getOssListByName", "json", function (res) {
                        const length = res.ossList.length;

                        if (length == 1) {
                            alertify.alert(String([[ #{msg.oss.required.version} ]]), function(){});

                        } else if (length > 1) {
                            getAjaxJsonData({ossName : ossNameInputValue}, "/oss/checkExistsOssByname", "json", function (res) {
                                if (res.isValid === true || res.isValid === 'true') {
                                    let _popup = null;
                                    let _encUrl = "ossName=" + oss_edit_fn.replaceGetParamChar(encodeURIComponent(ossNameInputValue)) + "&ossVersion=" + oss_edit_fn.replaceGetParamChar(ossVersionInputValue)+"&ossId="+ossId;

                                    if(_popup == null || _popup.closed) {
                                        _popup = window.open(`/oss/osssyncpopup?${_encUrl}`, `ossSyncViewPopup_${_encUrl}`, "width=1000, height=700, toolbar=no, location=no, left=100, top=100");

                                        if(!_popup || _popup.closed || typeof _popup.closed=='undefined') {
                                            alertify.alert(String([[ #{msg.common.window.allowpopup} ]]), function(){});
                                        }
                                    } else {
                                        _popup.close();
                                        _popup = window.open(`/oss/osssyncpopup?${_encUrl}`, `ossSyncViewPopup_${ossName}`, "width=1000, height=700, toolbar=no, location=no, left=100, top=100");
                                    }
                                } else {

                                }
                            }, function () {

                            })
                        }
                    }, function () {

                    })
                }
            },
            copyOssPage : function () {
                const ossId = oss_edit_data.ossId;
                window.location.href = "/oss/copy/" + ossId;
            },
            replaceGetParamChar : function(_param) {
                _param = _param.replace(/&/g,"%26");
                _param = _param.replace(/\+/g,"%2B");
                return _param;
            },

        }

        const oss_edit_cmt = {
            getCommentList: function () {
                const data = {
                    referenceId: oss_edit_data.ossId,
                    referenceDiv: '40'
                };

                getAjaxJsonData(data, "/comment/getDivCommentList", 'html', function (res) {
                    $("#commentAreaFragment").replaceWith(res);
                    $("[name ='commentModifyBtn']").on("click", function (e){
                        e.preventDefault();
                        oss_edit_cmt.handlePromptPopupOpen($(this).attr("data-commId"), $(this).attr("data-contents"));
                    })
                    $("[name ='commentDeleteBtn']").on("click", function (e){
                        e.preventDefault();
                        oss_edit_cmt.deleteComment($(this))
                    })
                }, function (xhr, ajaxOptions, thrownError) {
                    alertify.error(String([[ #{msg.common.valid2}]]), 0);
                });
            },
            deleteComment: function (event) {
                const commId = event.attr('data-commId');
                if (!confirm(String([[#{msg.oss.confirm.delete.comment}]]))) {
                    return;
                }

                postAjaxData({'commId': commId}, "/comment/deleteComment", "json", function (data) {
                    alertify.error(String([[ #{msg.common.success}]]));
                    oss_edit_cmt.getCommentList();
                }, function () {
                    alertify.error(String([[ #{msg.common.valid2}]]), 0);
                });

            },
            handlePromptPopupOpen: function (id, contents)  {
                const param = {
                    data : {commId : id},
                    category : "fragments",
                    templateName: "popup-fragments",
                    fragmentName: "commentPopupFragment"
                }

                postAjaxJsonData(JSON.stringify(param), "/render/component", "html", function (res) {
                    alertify.confirm(res, function (e) {
                        if(e) {
                            oss_edit_cmt.editComment();
                        } else {
                            return false;
                        }
                    }).set('resizable', true)
                        .resizeTo('680px', '335px');
                }, null, function () {
                    $("#modifiedCommentEditor").summernote({
                        height: 100,
                        callbacks: {
                            onInit: function() {
                                $(this).summernote('code', contents);
                            }
                        }
                    });
                });
            },
            editComment: function () {
                const commId = $("#modifiedCommentId").val();
                const referenceId = $('input[name=ossId]').val();
                const contents = $('#modifiedCommentEditor').summernote('code');
                const param = {
                    'commId': commId,
                    'contents': contents,
                    'referenceDiv': '40',
                    'referenceId': referenceId
                };

                postAjaxData(param, "/comment/updateComment", "json", function () {
                        alertify.success(String([[ #{msg.common.success}]]), 0);
                    }, function () {
                        alertify.error(String([[ #{msg.common.valid2}]]), 0);
                    }, function () {
                        oss_edit_cmt.getCommentList();
                });
            }
        }

        function getOssGridRows(elementId) {
            var grid = $(elementId);
            var dataToSend = [];
            var rows = grid.jqGrid('getDataIDs');
            for (idx = 0; idx < rows.length; idx++) {
                grid.jqGrid('saveRow', rows[idx]);
                var rowData = grid.jqGrid('getRowData', rows[idx]);
                dataToSend.push(rowData);
            }
            return dataToSend;
        }

        function setCustomAutoComplete(div) {
            var selected = false;
            if (div == 'single') {
                $('.autoComOssLicense').autocomplete({
                    source: licenseTags,
                    select: function (event, ui) {
                        var target = $(this).attr("id");

                        if (target == "licenseName") {
                            $("#licenseName").parent().find("span.retxt:first").hide();
                            var licenseName = ui.item.shortIdentifier.length > 0 ? ui.item.shortIdentifier : ui.item.licenseName;
                            $('#licenseName').val(licenseName);
                            showLicenseText(licenseName);

                            return false;
                        }
                    },
                    minLength: 0,
                    open: function () {
                        $(this).attr('state', 'open');
                        selected = false;

                    },
                    close: function () {
                        $(this).attr('state', 'closed');
                        var _item = checkLicenseSelected($(this).val());
                        var target = $(this).attr("id");

                        // detected License
                        $(this).parent().next("span.retxt:first").empty();
                        detectedLicenseValid = true; // reset

                        if (_item != null) {
                            var licenseName = _item.shortIdentifier.length > 0 ? _item.shortIdentifier : _item.licenseName;
                            $(this).val(licenseName);
                            selected = true;
                        } else {
                            var value = $(this).val();

                            if (value != "") {
                                $(this).parent().next("span.retxt:first").html(String([[ #{msg.oss.unknown.license}]])).show();
                                detectedLicenseValid = false;
                            }
                        }
                    }
                })
                    .focus(function () {
                        if ($(this).attr('state') != 'open') {
                            $(this).autocomplete("search");
                        }
                    })
                    .autocomplete("instance")._renderItem = function (ul, item) {
                    return $("<li>")
                        .append("<div>" + item.label + "<strong> (" + item.licenseType + ") </strong>" + item.obligation + item.restriction + "</div>")
                        .appendTo(ul);
                };
            } else if (div == 'multi') {
                $('#' + lastsel + '_licenseNameEx').autocomplete({
                    source: licenseTags,
                    select: function (event, ui) {
                        var licenseName = ui.item.shortIdentifier.length > 0 ? ui.item.shortIdentifier : ui.item.licenseName;
                        $('#' + lastsel + '_licenseNameEx').val(licenseName);
                        $('#' + lastsel + ' > td:eq(9)').text(licenseName); // licenseNameEx
                        $('#' + lastsel + ' > td:eq(7)').text(licenseName); // licenseName
                        $('#' + lastsel + ' > td:eq(10)').text(ui.item.licenseType); // licenseType
                        $('#' + lastsel + ' > td:eq(11)').text(ui.item.obligationChecks); // obligationChecks
                        $('#' + lastsel + ' > td:eq(8)').text(ui.item.licenseId); // licenseId
                        showLicenseText(licenseName);
                        gLicenseData[lastsel] = "Y";
                        return false;
                    },
                    minLength: 0,
                    open: function () {
                        $(this).attr('state', 'open');
                        selected = false;
                    },
                    change: function () {
                        gLicenseData[lastsel] = "N";
                    },
                    close: function () {
                        $(this).attr('state', 'closed');
                        let _item = checkLicenseSelected($(this).val());
                        let gridStr = "_licenseChoice";
                        $("div.retxt._licenseChoice_" + lastsel).remove();
                        if (_item == null) {
                            $("#" + lastsel + "_licenseNameEx").after('<div class=\"' + gridStr + "_" + lastsel + ' retxt\">' + '<spring:message code="msg.oss.unknown.license" />' + '</div>');
                            $("div.retxt._licenseChoice_" + lastsel).show();
                        } else {
                            let licenseName = _item.shortIdentifier.length > 0 ? _item.shortIdentifier : _item.licenseName;

                            $('#' + lastsel + '_licenseNameEx').val(licenseName);
                            $('#_licenseChoice').jqGrid('saveRow', lastsel);

                            let rowData = $('#_licenseChoice').jqGrid('getRowData', lastsel);
                            rowData['licenseId'] = _item.licenseId;
                            rowData['licenseName'] = _item.licenseName;
                            rowData['licenseNameEx'] = licenseName;
                            rowData['licenseType'] = _item.licenseType;
                            rowData['obligation'] = _item.obligation;
                            rowData['obligationChecks'] = _item.obligationChecks;
                            rowData['ossLicenseIdx'] = lastsel;
                            rowData['no'] = lastsel;

                            list.forEach(function (row, index) {
                                if (row.ossLicenseIdx == lastsel) {
                                    list.splice(index, 1, rowData);
                                }
                                ;
                            });

                            $('#_licenseChoice').jqGrid('editRow', lastsel);
                            // 첫 로우 ossLicenseComb 설정
                            changeLicenseType();
                            setFristComb();
                            selected = true;
                        }
                    }
                })
                    .focus(function () {
                        if ($(this).attr('state') != 'open') {
                            $(this).autocomplete("search");
                        }
                    })
                    .autocomplete("instance")._renderItem = function (ul, item) {
                    return $("<li>")
                        .append("<div>" + item.label + "<strong> (" + item.licenseType + ") </strong>" + item.obligation + item.restriction + "</div>")
                        .appendTo(ul);
                };
            }
        }

        function checkLicenseSelected(val) {
            if (val == "") {
                return null;
            }

            val = val.toUpperCase().trim();

            for (var idx = 0; idx < licenseTags.length; idx++) {
                if (licenseTags[idx].licenseName.toUpperCase().trim() == val || licenseTags[idx].shortIdentifier.toUpperCase().trim() == val) {
                    return licenseTags[idx];
                }
            }

            return null;
        }

        function getLicenseGroup(groups) {
            var numbers = [];

            groups.forEach(function (group) {
                var number = compareLicenseGroupMax(group);
                numbers.push(number);
            });

            return numbers;
        }

        //라이센스 우선순위 자동 계산
        function autoLicense(data) {
            var licenseCount = 0;
            data.forEach(function (data) {
                if (data.licenseName) {
                    licenseCount += 1;
                }
            })

            var result = '';
            if (licenseCount != 0) {
                //1. 그룹별 분류하기
                var groups = distributeGroups(data);
                var numbers = getLicenseGroup(groups);

                //2. 각 그룹끼리 비교하기(OR 비교)
                if (numbers.length != 1) {
                    var min = getMin(numbers);
                    switch (min) {
                        case 1:
                            result = 'Permissive';
                            $('#licenseType').val("PMS");
                            break;
                        case 2:
                            result = 'Weak Copyleft';
                            $('#licenseType').val("WCP");
                            break;
                        case 3:
                            result = 'Copyleft';
                            $('#licenseType').val("CP");
                            break;
                        case 4:
                            result = 'Proprietary Free';
                            $('#licenseType').val("PF");
                            break;
                        case 5:
                            result = 'Proprietary';
                            $('#licenseType').val("NA");
                            break;
                    }
                } else {
                    var min = numbers[0];
                    switch (min) {
                        case 1:
                            result = 'Permissive';
                            $('#licenseType').val("PMS");
                            break;
                        case 2:
                            result = 'Weak Copyleft';
                            $('#licenseType').val("WCP");
                            break;
                        case 3:
                            result = 'Copyleft';
                            $('#licenseType').val("CP");
                            break;
                        case 4:
                            result = 'Proprietary Free';
                            $('#licenseType').val("PF");
                            break;
                        case 5:
                            result = 'Proprietary';
                            $('#licenseType').val("NA");
                            break;
                    }
                }
            }
            return result;
        }

        //Obligation 우선순위 자동계산
        function autoObligation(data) {
            var licenseCount = 0;
            data.forEach(function (data) {
                if (data.licenseName) {
                    licenseCount += 1;
                }
            })
            var result = '';
            if (licenseCount != 0) {
                //1. 그룹별 분류하기
                var groups = distributeGroups(data);
                var numbers = getLicenseGroup(groups);

                //2. 각 그룹끼리 비교하기(OR 비교)
                if (numbers.length != 1) {
                    var min = getMin(numbers);
                    var number = compareObligationGroupMax(groups[numbers.indexOf(min)]);
                    switch (number) {
                        case 1:
                            result = '<span></span>';
                            break;
                        case 2:
                            result = '<span class=\"iconSet ops\" title=\"Notice\"></span>';
                            $('input[name=obligationType]').val("10");
                            break;
                        case 3:
                            result = '<span class=\"iconSet ops\" title=\"Notice\"></span><span class=\"iconSet man\" title=\"Source Code\"></span>';
                            $('input[name=obligationType]').val("11");
                            break;
                    }
                } else {
                    var min = numbers[0];
                    var number = compareObligationGroupMax(groups[0]);

                    switch (number) {
                        case 1:
                            result = '<span></span>';
                            break;
                        case 2:
                            result = '<span class=\"iconSet ops\" title=\"Notice\"></span>';
                            $('input[name=obligationType]').val("10");
                            break;
                        case 3:
                            result = '<span class=\"iconSet ops\" title=\"Notice\"></span><span class=\"iconSet man\" title=\"Source Code\"></span>';
                            $('input[name=obligationType]').val("11");
                            break;
                    }
                }
            }

            return result;
        }

        //AND그룹으로 묶어서 분류하기
        function distributeGroups(data) {
            var type = 'A';
            var groups = [];
            var groupA = [];
            var groupB = [];

            data.forEach(function (item, index, ref) {
                if (item.ossLicenseComb == 'AND' || item.ossLicenseComb == "") {
                    if (groupA.length > 0) {	//AND - AND 배열 결속

                    }

                    if (groupB.length > 0) {	//OR - AND 배열 결속
                        groupA.push(groupB[0]);
                        groupB = [];
                    }

                    groupA.push(item);
                } else if (item.ossLicenseComb == 'OR') {
                    if (groupA.length > 0) {	//AND - OR 배열 변경 (이전까지 등록된 배열을 그룹에 등록후 배열 초기화)
                        groups.push(groupA);
                        groupA = [];
                    }

                    if (groupB.length > 0) {  //OR - OR 배열 변경 (바로 전 등록된 배열을 그룹에 등록후 배열 초기화)
                        groups.push(groupB);
                        groupB = [];
                    }

                    groupB.push(item);
                }

                if (index == ref.length - 1) {	//마지막 순서일 때 최종 등록
                    if (groupA.length > 0) {
                        groups.push(groupA);
                    }

                    if (groupB.length > 0) {
                        groups.push(groupB);
                    }
                }
            });

            return groups;
        }

        /*
            AND그룹 내 라이센스 우선순위 비교
            (AND - Copyleft > Weak Copyleft > Permissive)
        */
        function compareLicenseGroupMax(group) {
            var max = 0;
            var constant = {
                'Permissive': 1,
                'Weak Copyleft': 2,
                'Copyleft': 3,
                'Proprietary Free': 4,
                'Proprietary': 5
            };
            group.forEach(function (item, index, ref) {
                if (max < constant[item.licenseType]) {
                    max = constant[item.licenseType];
                }
            });
            return max;
        }

        /*
            AND그룹 내 Obligation 우선순위 비교
            (AND - Copyleft > Weak Copyleft > Permissive)
        */
        function compareObligationGroupMax(group) {
            var max = 0;
            var constant = {
                'NNY': 1,
                'NNN': 1,
                'YNY': 2,
                'YNN': 2,
                'YYY': 3,
                'YYN': 3
            };

            group.forEach(function (item, index, ref) {
                if (max < constant[item.obligationChecks]) {
                    max = constant[item.obligationChecks];
                }
            });
            return max;
        }

        //숫자배열 중 최소값 찾기(AND조건의 역순)
        function getMin(numbers) {
            var min = 9;
            numbers.forEach(function (number) {
                if (min > number) {
                    min = number;
                }
            });
            return min;
        }

        //숫자배열 중 최대값 찾기(AND조건의 역순)
        function getMax(numbers) {
            var max = 0;
            numbers.forEach(function (number) {
                if (max < number) {
                    max = number;
                }
            });
            return max;
        }

        //save동작 처리
        function saveRow() {
            $('#_licenseChoice').jqGrid('saveRow', lastsel);
            $('#_licenseChoice').jqGrid('resetSelection');	// 셀렉트 해제
        }

        function changeLicenseType() {
            $('#_licenseChoice').jqGrid('saveRow', lastsel);
            //var list = data.list.rows;
            list = $('#_licenseChoice').jqGrid('getRowData');
            var type = autoLicense(list);
            var obligationHtml = autoObligation(list);

            if (list.length == 0) {
                type = '';
                obligationHtml = '';
            }

            $('#lt td').html(type);
            $('#ob td').html('');
            $(obligationHtml).appendTo('#ob td');
            $('#_licenseChoice').jqGrid('editRow', lastsel);
        }

        //라이센스 묶음 처리
        function createMultiLicenseText() {
            var rows = $('#_licenseChoice').jqGrid('getRowData');
            var markTxt = '';

            rows.forEach(function (row, index, ref) {
                var olc = row.ossLicenseComb, lnm = row.licenseNameEx;
                var ossLicenseComb, licenseName;
                var url = "/license/edit/" + row.licenseId;

                ossLicenseComb = /<[a-z][\s\S]*>/i.test(olc) ? $("#" + $(olc).attr("id")).val() : olc;
                licenseName = /<[a-z][\s\S]*>/i.test(lnm) ? $("#" + $(lnm).attr("id")).val() : lnm;

                if (index != 0) {
                    markTxt += ' <span> ' + ossLicenseComb + ' </span> ';
                }

                markTxt += `<a href="javascript:void(0)" onclick="callCreateTabInFrame('${row.licenseId}_License', '${url}', 'license-edit${row.licenseId}', true)">${licenseName}</a>`;
            });

            var andTxts = markTxt.split('<span> OR </span>');

            markTxt = '';

            andTxts.forEach(function (andTxt, index, ref) {
                var isAnd = andTxt.split('AND').length > 1;
                if (isAnd) {
                    markTxt += '(' + andTxt + ')';
                } else {
                    markTxt += andTxt;
                }
                if (index != ref.length - 1) {
                    markTxt += '<span> OR </span>';
                }
            });

            if (markTxt.split('OR').length == 1 && markTxt[0] == '(' && markTxt[markTxt.length - 1] == ')') {
                markTxt = markTxt.substring(1, markTxt.length - 1);
            }

            if (markTxt.indexOf('undefined') == -1) {
                $('#licenseMarkText').html(markTxt);
            }
        }

        function getOssGridRows(elementId) {
            var grid = $(elementId);
            var dataToSend = [];
            var rows = grid.jqGrid('getDataIDs');
            for (idx = 0; idx < rows.length; idx++) {
                grid.jqGrid('saveRow', rows[idx]);
                var rowData = grid.jqGrid('getRowData', rows[idx]);
                dataToSend.push(rowData);
            }
            return dataToSend;
        }

        function validationDataSet() {
            var licenseDiv = "";
            var licenseChoiceLength = $("#_licenseChoice").jqGrid("getDataIDs").length;

            switch (licenseChoiceLength) {
                case 0:
                    alertify.alert(String([[ #{msg.oss.required.license}]]), function () {
                    });
                    return false;
                    break;
                case 1:
                    licenseDiv = "S";
                    break;
                default:
                    licenseDiv = "M";
                    break;
            }

            var rows = getOssGridRows('#_licenseChoice');

            $('input[name=licenseDiv]').val(licenseDiv);

            var dataIds = $('#_licenseChoice').jqGrid('getDataIDs');
            var newRows = [];
            var checkLicenses = [];
            dataIds.forEach(function (dataId) {
                var rowData = $('#_licenseChoice').jqGrid('getRowData', dataId);
                var licenseName = rowData.licenseName;
                if (licenseName.indexOf('<div') > -1) {
                    rowData['licenseName'] = '';
                }
                checkLicenses.push(rowData.licenseNameEx);
                newRows.push(rowData);
            });

            $('input[name=ossLicensesJson]').val(JSON.stringify(newRows));

            $("[name='downloadLocations']").each(function (idx, cur) {
                $(cur).val($(cur).val().trim());
            });

            $("[name='homepage']").each(function (idx, cur) {
                $(cur).val($(cur).val().trim());
            });

            var nicknameFormatErrorFlag = true;
            $("[name='ossNicknames']").each(function (idx, cur) {
                var nickname = $(cur).val();

                if (nickname.indexOf(",") > -1) {
                    fn.checkNickName(cur);
                    nicknameFormatErrorFlag = false;
                }
            });

            if (!nicknameFormatErrorFlag) {
                alertify.alert("Formatting error", function () {
                });

                return false;
            }

            var duplicatedLicenseFlag = true;
            if (checkLicenses.length > 0) {
                $.each(checkLicenses, function (index, element) {
                    $("[name='detectedLicenses']").each(function (idx, cur) {
                        var detectedLicense = $(cur).val();
                        if (detectedLicense && element == detectedLicense) {
                            $('input[name=detectedLicenses]:eq(' + idx + ')').parent().next("span.retxt").html("License included in Declared").show();
                            duplicatedLicenseFlag = false;
                            return true;
                        }
                    });
                });
            }

            if (!duplicatedLicenseFlag) {
                alertify.error("License included in Declared", 0);
                return false;
            }

            return true;
        }

        //OSS등록로직
        function registSubmit() {
            if (validationDataSet()) {
                $("#ossForm").ajaxForm({
                    url: "/oss/validation",
                    type: 'POST',
                    dataType: "json",
                    cache: false,
                    success: onValidSuccess,
                    error: onError
                }).submit();
            }
        }

        // OSS 삭제 체크 (기존에 CONF 상태로 등록된 OSS가 있는지 여부 검사)
        function checkExistOssConf() {
            var ossId = $('input[name=ossId]').val();

            $.ajax({
                url: '<c:url value="/oss/checkExistOssConf"/>',
                type: 'GET',
                dataType: 'json',
                cache: false,
                data: {'ossId': ossId},
                success: function (data) {
                    if (parseInt(data) > 0) {
                        loading.hide();

                        $('.ossSelectPop').show();
                        $('#blind_wrap').show();
                    } else if (parseInt(data) == 0) {
                        deleteOssByOne();
                    } else {
                        loading.hide();
                        alertify.error('<spring:message code="msg.common.valid2" />', 0);
                    }
                },
                error: function () {
                    loading.hide();
                    alertify.error('<spring:message code="msg.common.valid2" />', 0);
                }
            });
        };

        // OSS 삭제
        function deleteOssByOne() {
            var ossId = $('input[name=ossId]').val();
            var ossName = $('input[name=ossName]').val();
            var editorVal = CKEDITOR.instances['editor'].getData();
            var sendData = {
                ossId: ossId,
                ossName: ossName,
                newOssId: "N", // 단건일때 "N" 로 보냄
                comment: editorVal
            };

            $.ajax({
                url: '<c:url value="/oss/delAjax"/>',
                type: 'POST',
                data: sendData,
                dataType: "json",
                cache: false,
                success: function (json) {
                    loading.hide();
                    if (json.resCd == '10') {
                        alertify.alert('<spring:message code="msg.common.success" />', function () {
                            deleteTabInFrame('#<c:url value="/oss/edit/' + ossId + '"/>');
                            reloadTabInframe('<c:url value="/oss/list"/>');
                        });
                    } else {
                        alertify.error('<spring:message code="msg.common.valid" />', 0);
                    }
                },
                error: function () {
                    loading.hide();
                    alertify.error('<spring:message code="msg.common.valid2" />', 0);
                }
            });
        };

        //V-Diff 체크
        function checkVdiff(func) {
            var rtnData = {};
            var rows = getOssGridRows('#_licenseChoice');
            var ossVersion = $('input[name=ossVersion]').val();
            var postData = {
                'ossId': $('input[name=ossId]').val(),
                'ossName': $('input[name=ossName]').val(),
                'license': JSON.stringify(rows)
            };

            if ("save" == func && "" != ossVersion) {
                postData['ossVersion'] = ossVersion;
            }

            postAjaxJsonData(JSON.stringify(postData), "/oss/checkVdiff", 'json', function (json) {
                rtnData = json.vFlag;
            }, function () {
                alertify.error(String([[ #{msg.common.valid2}]]), 0);
            })
            // $.ajax({
            //     url : "/oss/checkVdiff",
            //     type : 'POST',
            //     data : JSON.stringify(postData),
            //     dataType : 'json',
            //     cache : false,
            //     async : false,
            //     contentType : 'application/json',
            //     success : function(json){
            //         rtnData = json.vFlag;
            //     },
            //     error : function(){
            //         alertify.error('<spring:message code="msg.common.valid2" />', 0);
            //     }
            //});

            rtnData['ossVersion'] = ossVersion;
            return rtnData;
        };

        // 그리드 체크 메세지( gridStr 그리드 문자열 )
        function ossGridValidMsg(msgData, gridStr) {
            $.each(msgData, function (key, value) {
                if ("isValid" != key) {
                    if (key.indexOf(".") > -1) {
                        if (key.indexOf("ossNicknames") > -1) {
                            var _nickIndex = key.substring(key.lastIndexOf(".") + 1, key.length) - 1;
                            $('input[name=ossNicknames]:eq(' + _nickIndex + ')').parent().next("span.retxt").html(value).show();
                        } else {
                            var seqSuffix = key.split(".");
                            var rowId = seqSuffix[1];
                            // licenseId 일 경우 에러 메세지 타겟을 licenseNameEx 로 변경
                            if (seqSuffix[0] === "licenseId") {
                                seqSuffix[0] = "licenseNameEx";
                            }
                            var colName = $("#" + gridStr + " #" + rowId).parents("table").attr("id") + "_" + seqSuffix[0];
                            // 그리드 메세지 그리기
                            $("#" + gridStr + " #" + rowId + " td[aria-describedby=\"" + colName + "\"]")
                                .append('<div class=\"' + gridStr + "_" + rowId + ' retxt"\">' + value + '</div>');
                        }
                        $("div.retxt").show();
                    } else {
                        if (key == 'ossNicknames') {
                            $('input[name=ossNicknames]').parent().next("span.retxt").html(value).show();
                        }
                        if ($('input[name=' + key + ']').length > 0) {
                            $('input[name=' + key + ']').next("span.retxt").html(value).show();
                        } else if ($('textarea[name=' + key + ']').length > 0) {
                            $('textarea[name=' + key + ']').next("span.retxt").html(value).show();
                        } else if ($('select[name=' + k + ']').length > 0) {
                            $('select[name=' + key + ']').parent().siblings("span.retxt").html(value).show();
                        }
                    }
                    // 라셀 초기화
                    lastsel = -1;
                }
            });
        };

        //유효성 체크 콜백함수
        function onValidSuccess(json, status) {
            loading.hide();

            if (json.isValid == 'false') {
                if (json.validMsg == "hasDelNick") {

                    if ($("div.multiTxtSet > div").length > 1) {
                        $("div.multiTxtSet > div:not(:nth-child(1))").remove();
                    }

                    for (var k in json.resultData.addNickArr) {
                        $(nickNameClone).appendTo('.multiTxtSet');
                        $('.multiTxtSet input[type=text]:last').val(json.resultData.addNickArr[k]);
                    }

                    $('.smallDelete').on('click', function () {
                        $(this).parent().remove();
                    });

                    var _alertMsg = String([[ #{msg.oss.nickname.exists} ]]);
                    if (json.resultData.delNickArr) {
                        _alertMsg += '<br/><br/><b>Removed Nick Name List</b><span style="text-decoration:line-through;">';
                        for (var k in json.resultData.delNickArr) {
                            _alertMsg += '<br/>' + json.resultData.delNickArr[k];
                        }
                        _alertMsg += '</span>';
                    }

                    alertify.alert(_alertMsg, function () {
                    });
                } else if (json.validMsg == "rename") {
                    if (typeof json.resultData !== 'undefined') {
                        var data = json.resultData;
                        var _alertMsg = String([[ #{msg.oss.check.rename}]]);
                        for (var i in data) {
                            _alertMsg += '<br> - ' + data[i];
                        }
                        alertify.alert(_alertMsg, function () {
                        });
                    } else {
                        alertify.alert('The OSS is the same, so it cannot be changed.', function () {
                        });
                    }

                    renameFlag = 'N';
                    $('input[name=renameFlag]').val(renameFlag);
                } else if (json.validMsg == "notChange") {
                    alertify.alert(String([[ #{msg.oss.name.nickname.sametime.notchange}]]), function () {
                    });
                } else if (json.resultData) {
                    var _alertMsg = String([[ #{msg.oss.nickname.exists}]]);
                    _alertMsg += '<br><br>' + 'When registering a new OSS or adding a version, it is not possible to delete the nickname of the existing OSS.';
                    alertify.alert(_alertMsg, function () {
                    });

                    for (var k in json.resultData) {
                        $(nickNameClone).appendTo('.multiTxtSet');
                        $('.multiTxtSet input[type=text]:last').val(json.resultData[k]);
                    }

                    $('.smallDelete').on('click', function () {
                        $(this).parent().remove();
                    });
                } else if (json.validMsg == "deactivate") {
                    alertify.error(String([[ #{msg.oss.deactivated}]]), 0);
                } else if (json.ossName == "Formatting error") {
                    alertify.error(String([[ #{msg.common.valid}]]), 0);
                    // 커스텀 에러 메세지
                    ossGridValidMsg(json, "_licenseChoice");
                } else {
                    //alertify.error('<spring:message code="msg.common.valid"/>', 0);
                    alertify.error(String([[ #{msg.oss.duplicated}]]), 0);
                    // 커스텀 에러 메세지
                    ossGridValidMsg(json, "_licenseChoice");
                }
            } else if (json.isValid == 'true') {
                var data = checkVdiff('save');
                var v_flag = data.vFlag;

                if (v_flag == "Y") {
                    if ("" != data.ossVersion) {
                        if (typeof data.resultData != "undefined") {
                            var checkList = data.resultData;
                            var height = 0;
                            let vDiffDiv = document.createElement('div');
                            vDiffDiv.id = 'vDiffDiv';
                            let h1 = document.createElement('h1');
                            h1.innerHTML = String([[ #{msg.oss.confirm.ossVersion}]]);
                            vDiffDiv.appendChild(h1);
                            vDiffDiv.appendChild(document.createElement('br'));
                            height += 30;

                            let table = document.createElement('table');
                            table.style.width = '100%';
                            $(table).css('border-collapse', 'collapse');
                            let thead = document.createElement('thead');
                            let tbody = document.createElement('tbody');

                            let row_1 = document.createElement('tr');
                            $(row_1).css('background-color', '#a39d9b');
                            row_1.style.height = "30";
                            height += 30;

                            let heading_1 = document.createElement('th');
                            heading_1.style.border = '1px solid #444444';
                            $(heading_1).css('font-weight', 'bold');
                            $(heading_1).css('color', 'white');
                            heading_1.innerHTML = "OSS Name (version)";

                            let heading_2 = document.createElement('th');
                            heading_2.style.border = '1px solid #444444';
                            $(heading_2).css('font-weight', 'bold');
                            $(heading_2).css('color', 'white');
                            heading_2.innerHTML = "Declared License";

                            row_1.appendChild(heading_1);
                            row_1.appendChild(heading_2);

                            thead.appendChild(row_1);
                            table.appendChild(thead);

                            for (var j in checkList) {
                                var ossInfo = checkList[j].split("|")[0];
                                var declaredLicense = checkList[j].split("|")[1];

                                let row_2 = document.createElement('tr');
                                row_2.style.height = "30";
                                height += 30;

                                let row_2_data_1 = document.createElement('td');
                                row_2_data_1.style.border = '1px solid #444444';
                                row_2_data_1.innerHTML = '&nbsp;' + ossInfo;

                                let row_2_data_2 = document.createElement('td');
                                row_2_data_2.style.border = '1px solid #444444';
                                row_2_data_2.innerHTML = '&nbsp;' + declaredLicense;

                                row_2.appendChild(row_2_data_1);
                                row_2.appendChild(row_2_data_2);
                                tbody.appendChild(row_2);
                            }

                            table.appendChild(tbody);
                            vDiffDiv.appendChild(table);

                            height = (height + 160) < 750 ? (height + 160) : 750;

                            if (!alertify.firstVDiffDialog) {
                                alertify.dialog('firstVDiffDialog', function () {
                                    var settings;

                                    return {
                                        setup: function () {
                                            var settings = alertify.confirm().settings;

                                            for (var prop in settings) {
                                                this.settings[prop] = settings[prop];
                                            }

                                            var setup = alertify.confirm().setup();

                                            setup.focus.element = 1;

                                            return setup;
                                        },
                                        settings: {
                                            oncontinue: null
                                        },
                                        callback: function (closeEvent) {
                                            alertify.confirm().callback.call(this, closeEvent);
                                        }
                                    };
                                }, false, 'confirm');

                                alertify.firstVDiffDialog(vDiffDiv)
                                    .set('onok', function (closeEvent) {
                                        onRegist();
                                    })
                                    .set('oncancel', function (closeEvent) {
                                        return;
                                    });
                            } else {
                                alertify.firstVDiffDialog(vDiffDiv)
                                    .set('onok', function (closeEvent) {
                                        onRegist();
                                    })
                                    .set('oncancel', function (closeEvent) {
                                        return;
                                    })
                                    .set('resizable', true).resizeTo('25%', height);
                            }
                        } else {
                            onRegist();
                        }
                    } else {
                        alertify.confirm(String([[ #{msg.oss.confirm.ossVersion}]]), function (e) {
                            if (e) {
                                onRegist();
                            } else {
                                return false;
                            }
                        });
                    }
                } else if (v_flag == "") {
                    alertify.error(String([[ #{msg.common.valid2}]]), 0);
                    return;
                } else {
                    onRegist();
                }
            }
        };

        //유효성 체크 콜백함수
        function onDeleteValidSuccess(json, status) {
            if (json.isValid == 'false') {
                loading.hide();

                if (json.validMsg == "hasDelNick") {
                    // oss name을 변경하면서 nick name을 다시 확인 할 필요가 있는 경우

                    // nick name 필드 초기화
                    if ($("div.multiTxtSet > div").length > 1) {
                        $("div.multiTxtSet > div:not(:nth-child(1))").remove();
                    }

                    for (var k in json.resultData.addNickArr) {
                        $(nickNameClone).appendTo('.multiTxtSet');
                        $('.multiTxtSet input[type=text]:last').val(json.resultData.addNickArr[k]);
                    }
                    $('.smallDelete').on('click', function () {
                        $(this).parent().remove();
                    });
                    var _alertMsg = '<spring:message code="msg.oss.nickname.exists"/>';
                    if (json.resultData.delNickArr) {
                        _alertMsg += '<br/><br/><b>Removed Nick Name List</b><span style="text-decoration:line-through;">';
                        for (var k in json.resultData.delNickArr) {
                            _alertMsg += '<br/>' + json.resultData.delNickArr[k];
                        }
                        _alertMsg += '</span>';
                    }
                    alertify.alert(_alertMsg, function () {
                    });
                } else if (json.resultData) {
                    alertify.alert('<spring:message code="msg.oss.nickname.exists"/>', function () {
                    });
                    for (var k in json.resultData) {
                        $(nickNameClone).appendTo('.multiTxtSet');
                        $('.multiTxtSet input[type=text]:last').val(json.resultData[k]);
                    }
                    $('.smallDelete').on('click', function () {
                        $(this).parent().remove();
                    });

                } else {
                    alertify.error('<spring:message code="msg.common.valid"/>', 0);
                    // 커스텀 에러 메세지
                    ossGridValidMsg(json, "_licenseChoice");
                }

            } else if (json.isValid == 'true') {
                var v_flag = checkVdiff('delete');

                if (v_flag == "") {
                    loading.hide();
                    alertify.error('<spring:message code="msg.common.valid2" />', 0);
                    return;

                } else {
                    checkExistOssConf();
                }
            }
        };

        //저장함수
        function onRegist() {
            loading.show();
            saveRow();
            var editorVal = $("#commentCont").summernote('code');
            $('input[name=comment]').val(replaceWithLink(editorVal));

            formAjaxData("#ossForm", "/oss/saveAjax", onRegistSuccess, onError);
        };

        //등록성공콜백함수
        function onRegistSuccess(json, status) {
            loading.hide();

            if (json.resCd == '10') {
                alertify.alert(String([[ #{msg.common.success}]]), function () {
                    if(oss_edit_data.isCopyData) {
                        callDeleteTabInFrame("oss-edit_" + oss_edit_data.ossId);
                    } else {
                        callDeleteTabInFrame("oss-edit_" + json.ossId);
                    }
                    callReloadTabInframe("/oss/list", "oss-list");
                });
            } else {
                alertify.error(String([[ #{msg.common.valid2}]]), 0);
                renameFlag = 'N';
                $('input[name=renameFlag]').val(renameFlag);
            }
        };

        // 색 설정
        function makeBackGroundColor() {
            var colors = [];
            var list = [];
            // <c:forEach var="colors" items='${ct:getCodeNames(ct:getConstDef("CD_LICENSE_BACKGROUND"))}' varStatus="vs">
            //     colors.push("${colors}");
            // </c:forEach>
            var lastColor = colors[0];
            for (var i = 0; i < list.length; i++) {
                var comb = list[i].ossLicenseComb;
                if (comb == 'AND') {
                    $("#_licenseChoice").jqGrid("setRowData", list[i].ossLicenseIdx, false, {'background-color': lastColor});
                } else if (comb == 'OR') {
                    var flag = false;
                    for (var j = 0; j < colors.length; j++) {
                        if (lastColor == colors[j]) {
                            lastColor = colors[j + 1];
                            $("#_licenseChoice").jqGrid("setRowData", list[i].ossLicenseIdx, false, {'background-color': lastColor});
                            flag = true;
                        } else if (lastColor == colors[colors.length - 1]) {
                            lastColor = colors[0];
                            $("#_licenseChoice").jqGrid("setRowData", list[i].ossLicenseIdx, false, {'background-color': lastColor});
                            flag = true;
                        }
                        if (flag) break;
                    }
                }
            }
        }

        function onPopupListSuccess(json, status) {
            $('#_ossSelectList').jqGrid('clearGridData');
            $('#_ossSelectList').jqGrid('setGridParam', {data: json}).trigger('reloadGrid');

        }

        //에러엘럿
        function onError(data, status) {
            alertify.error(String([[ #{msg.common.valid2}]]), 0);
            renameFlag = 'N';
            $('input[name=renameFlag]').val(renameFlag);
        };

        function deleteComment(obj) {
            if (!confirm(String([[#{msg.oss.confirm.delete.comment}]]))) return;
            var commId = $(obj).next().val();

            getAjaxJsonData({'commId': commId}, "/oss/deleteComment", 'json', function () {
                fn_commemt.getCommentList();
            }, function () {
                alertify.error(String([[ #{msg.common.valid2}]]), 0);
            });
        }

        function modifyComment(obj) {
            $('.commModifyPop').show();
            $('#blind_wrap').show();
            var commId = $(obj).next().next().val();
            modifyCommentId = commId;
            var contents = $(obj).parent().parent().next().html();
            CKEDITOR.instances.editor3.setData(contents);

            //코멘트 수정
            $('.closeModComment').off("click").on("click", function () {
                $('.commModifyPop').hide();
                $('#blind_wrap').hide();
            });

            $('.modifyComment').off("click").on("click", function () {
                var editorVal = CKEDITOR.instances.editor3.getData();
                var register = '${sessUserInfo.userId}';
                var param = {
                    commId: modifyCommentId,
                    referenceId: data.detail.ossId,
                    referenceDiv: '40',
                    contents: replaceWithLink(editorVal)
                };
                $.ajax({
                    url: "/oss/saveComment",
                    type: 'POST',
                    dataType: 'json',
                    cache: false,
                    data: param,
                    success: function (json) {
                        alertify.success(String([[ #{msg.common.success}]]));
                        if (json.isValid) {
                            if (json.isValid == 'false') {
                                createValidMsgComplex(json);
                                alertify.error(String([[ #{msg.common.valid}]]), 0);

                            } else if (json.isValid == 'true') {
                                alertify.alert([[ #{msg.common.success}]], function () {
                                });
                            }
                        } else {
                            alertify.alert([[ #{msg.common.success}]], function () {
                            });
                        }
                        $('.commModifyPop').hide();
                        $('#blind_wrap').hide();

                        fn_commemt.getCommentList();
                    },
                    error: function () {
                    }
                });
            });
        }

        function showLicenseText(_licenseName) {
            if (!_licenseName) {
                var licenseChoiceLength = $("#_licenseChoice").jqGrid("getDataIDs").length;

                switch (licenseChoiceLength) {
                    case 0:
                        alertify.alert(String([[ #{msg.oss.required.license}]]), function () {
                        });
                        return false;
                        break;
                    case 1:
                        $("input[name=licenseDiv]").val("S");
                        break;
                    default:
                        $("input[name=licenseDiv]").val("M");
                        break;
                }

                var _selectedRow = $("#_licenseChoice").jqGrid('getGridParam', "selrow");
                if (_selectedRow) {
                    var licenseNameEx = $('#_licenseChoice').jqGrid('getRowData', _selectedRow, 'licenseNameOrg');
                    licenseName = licenseNameEx['licenseNameEx'];
                } else {
                    if ($("#_licenseChoice").jqGrid("getDataIDs").length > 0) {
                        _selectedRow = $("#_licenseChoice").jqGrid("getDataIDs")[0];
                        licenseName = $('#_licenseChoice').jqGrid('getCell', _selectedRow, 'licenseNameEx');
                    }
                }
            } else {
                licenseName = _licenseName;
            }

            if (licenseName && licenseName != "") {
                getAjaxJsonData({licenseName: licenseName}, "/license/getLicenseText", 'json', function (data) {
                        if ("false" != data.isValid) {
                            $("#disp_licenseText").html(data.validMsg);
                            licenseName = "";
                        } else {
                            $("#disp_licenseText").html("");
                        }
                    },
                    function () {
                        $("#disp_licenseText").html("");
                    });
                // $.ajax({
                //     url : "/license/getLicenseText",
                //     type : 'GET',
                //     dataType : 'json',
                //     cache : false,
                //     data : {licenseName : licenseName},
                //     success : function(data){
                //         if("false" != data.isValid) {
                //             $("#disp_licenseText").html(data.validMsg);
                //             licenseName = "";
                //         } else {
                //             $("#disp_licenseText").html("");
                //         }
                //     },
                //     error : function(){
                //         $("#disp_licenseText").html("");
                //     }
                // });
            } else {
                $("#disp_licenseText").html("");
            }
        }

        // 다른 OSS로 이관하는 경우
        function mergeOssForDelete(newOssId) {

            $('.ossSelectPop').hide();
            $("#_ossMergeCheckList").jqGrid('GridUnload');
            $('.mergeOssCheckPop').show();
            //$("#div_mergeOssCheckPop_change").text(${ossId} + " => ");

            $('#_ossMergeCheckList').jqGrid({
                url: '<c:url value="/oss/ossMergeCheckList/${ossId}/' + newOssId + '"/>',
                datatype: 'json',
                jsonReader: {
                    repeatitems: false,
                    id: 'ossId',
                    root: function (obj) {
                        return obj.rows;
                    }
                },
                colNames: ['ID', 'Merge', 'Version', 'License', 'License Type', 'Obligation', 'Copyright', 'Download Location', 'HomePage', 'delOssId'],
                colModel: [
                    {name: 'ossId', index: 'ossId', width: 70, align: "center"},
                    {name: 'mergeStr', index: 'mergeStr', width: 70, align: "center"},
                    {name: 'ossVersion', index: 'ossVersion', width: 80, align: "left"},
                    {name: 'licenseName', index: 'licenseName', width: 150, align: "left"},
                    {name: 'licenseType', index: 'licenseType', width: 80, align: "left"},
                    {name: 'obligation', index: 'obligation', width: 80, align: "left"},
                    {name: 'copyright', index: 'copyright', width: 150, align: "left"},
                    {name: 'downloadLocation', index: 'downloadLocation', width: 100, align: "left"},
                    {name: 'homepage', index: 'homepage', width: 100, align: "left"},
                    {name: 'delOssId', index: 'delOssId', hidden: true}
                ],
                autoencode: true,
                rowNum: 9999,
                autowidth: true,
                gridview: true,
                sortname: 'ossVersion',
                viewrecords: true,
                sortorder: 'desc',
                loadonce: true,
                height: 'auto',
                loadComplete: function (id) {
                    $('#_ossMergeCheckList').jqGrid("setRowData", '${ossId}', false, {'background-color': '#ada9a9'});
                },
                onSelectRow: function (id) {
                    $("div.retxt._licenseChoice_" + rowid).remove();

                },
                ondblClickRow: function (rowid, iRow, iCol, e) {
                    // 체크 박스 영역 제외
                    var row = $('#_ossMergeCheckList').jqGrid('getRowData', rowid);

                    // 자기자신이 아닌 경우만
                    if ('Duplicated' == row['mergeStr'] && row['delOssId'] && row['delOssId'] != '${ossId}') {
                        callcreateTabInFrame(row['delOssId'] + '_Opensource', "/oss/edit/" + row['delOssId']);
                    } else if (row['ossId'] != '${ossId}') {
                        createTabInFrame(row['ossId'] + '_Opensource', '#<c:url value="/oss/edit/' + row['ossId'] + '"/>');
                    }

                }
            });
        }

        function setFristComb() {
            $('#_licenseChoice').find("tr").eq(1).find("td").eq(3).text("");
        }

        function exeDelete(rowId) {
            $('#_licenseChoice').jqGrid('saveRow', lastsel);

            list.forEach(function (row, index) {
                if (row.ossLicenseIdx == rowId) {
                    list.splice(index, 1);
                };
            });


            // 해당 리스트 삭제
            $('#_licenseChoice').jqGrid('delRowData', rowId);
            // 첫 로우 ossLicenseComb 설정
            setFristComb();
            makeBackGroundColor();

            //라이센스 타입 및 Obligation 자동 체크
            var type = autoLicense(list);
            var obligationHtml = autoObligation(list);
            if (list.length == 0) {
                type = '';
                obligationHtml = '';
            }

            $('#lt td').html(type);
            $('#ob td').html('');
            $(obligationHtml).appendTo('#ob td');

            //라이센스 묶음 텍스트 출력
            createMultiLicenseText();
            lastsel = -1;
        }

        function showLicenseTextvalue(el) {
            if ($(el).val() == "Show license text") {
                $(el).val("Hide license text");
                $("#disp_licenseText").show();
                showLicenseText();
            } else {
                $(el).val("Show license text");
                $("#disp_licenseText").hide();
            }
        }

    </script>
</th:block>