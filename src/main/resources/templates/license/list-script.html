<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="script">
    <script th:inline="javascript">
        /*global $ */
        /*jslint browser: true, nomen: true */
        var initParam = {};
        var totalRow = 0;
        const G_ROW_CNT = [[${@CoCodeManager.getCodeExpString(@CommonFunction.getCoConstDefVal('CD_EXCEL_DOWNLOAD'), @CommonFunction.getCoConstDefVal('CD_MAX_ROW_COUNT'))}]];

        $(document).ready(function () {
            'use strict';
            setMaxRowCnt(G_ROW_CNT);
            evt.init();
            data.init();
        });

        //데이터 객체
        var data = {
            typeCodes: [],
            tooltipCont:
                "<div class=\"p-1\">" +
                    "<div class=\"mb-1\">" +
                        "<span style=\"float:left !important;\"><i class=\"far fa-file-alt fa-1-3x\" title=\"Notice\" style=\"margin-right: 10px !important;\"></i>Notice Obligation</span>" +
                    "</div>" +
                    "<div>" +
                        "<span style=\"float:left !important;\"><i class=\"far fa-file-code fa-1-3x\" title=\"Source Code\" style=\"margin-right: 10px !important;\"></i>Source Code Obligation</span>" +
                    "</div>"+
                "</div>",
            existTooltip: false,
            init: function () {
                list.load();	// Grid Load
            }
        };

        //이벤트 객체
        var evt = {
            init: function () {
                $('#restrictionSelect').select2({
                    placeholder: "Restriction",
                    allowClear: true,
                });

                $('#licenseTypeSelect').select2({
                    placeholder: "License Type",
                    allowClear: true,
                });

                $('#obligationTypeSelect').select2({
                    placeholder: "Obligation Type",
                    allowClear: true,
                });

                $('#creatorSelect').select2({
                    placeholder: "Creater",
                    allowClear: true,
                });

                $('#modifierSelect').select2({
                    placeholder: "Modifier",
                    allowClear: true,
                });

                /* created date & modified date event */
                let cStartDate = [[${searchBean.cStartDate}]];
                let cEndDate = [[${searchBean.cEndDate}]];

                $("#createdDate").daterangepicker({
                    autoUpdateInput: false
                }).on('apply.daterangepicker', function (ev, picker) {
                    $("input[name='cStartDate']").val(picker.startDate.format('YYYYMMDD'));
                    $("input[name='cEndDate']").val(picker.endDate.format('YYYYMMDD'));
                    $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));
                })
                .on('cancel.daterangepicker', function (ev, picker) {
                	$(this).val("");
                  	$("input[name='cStartDate']").val("");
                  	$("input[name='cEndDate']").val("");
                  	$('#createdDate').attr('placeholder', 'Created Date');
               	});

                if ((cStartDate != null && "" != cStartDate) && (cEndDate != null && "" != cEndDate)) {
                	var cStartDateFormat = cStartDate.substr(4,2) + "/" + cStartDate.substr(6,2) + "/" + cStartDate.substr(0,4);
                	var cEndDateFormat = cEndDate.substr(4,2) + "/" + cEndDate.substr(6,2) + "/" + cEndDate.substr(0,4);
                    $('#createdDate').val(cStartDateFormat + ' - ' + cEndDateFormat);
                } else {
                    $('#createdDate').attr('placeholder', 'Created Date');
                }

                let mStartDate = [[${searchBean.mStartDate}]];
                let mEndDate = [[${searchBean.mEndDate}]];

                $("#modifiedDate").daterangepicker({
                    autoUpdateInput: false
                }).on('apply.daterangepicker', function (ev, picker) {
                    $("input[name='mStartDate']").val(picker.startDate.format('YYYYMMDD'));
                    $("input[name='mEndDate']").val(picker.endDate.format('YYYYMMDD'));
                    $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));
                })
             	.on('cancel.daterangepicker', function (ev, picker) {
             		$(this).val("");
                 	$("input[name='mStartDate']").val("");
                   	$("input[name='mEndDate']").val("");
                   	$('#modifiedDate').attr('placeholder', 'Modified Date');
               	});

                if ((mStartDate != null && "" != mStartDate) && (mEndDate != null && "" != mEndDate)) {
                	var mStartDateFormat = mStartDate.substr(4,2) + "/" + mStartDate.substr(6,2) + "/" + mStartDate.substr(0,4);
                	var mEndDateFormat = mEndDate.substr(4,2) + "/" + mEndDate.substr(6,2) + "/" + mEndDate.substr(0,4);
                    $('#modifiedDate').val(mStartDateFormat + ' - ' + mEndDateFormat);
                } else {
                    $('#modifiedDate').attr('placeholder', 'Modified Date');
                }

                initParam = fn.setGridParam();
                var defaultSearchFlag = [[${searchBean.defaultSearchFlag}]];

                if (defaultSearchFlag != 'N') {
                    initParam.ignoreSearchFlag = "N";
                }

                $('#search').on('click', function (e) {
                    e.preventDefault();
                    var postData = fn.setGridParam();
                    postData.ignoreSearchFlag = "N";
                    $("#list").jqGrid('setGridParam', {postData: postData, page: 1}).trigger('reloadGrid');
                });

                $(".cal").on("keyup", function (e) {
                    calValidation(this, e);
                });

                $("#licenseNameAllSearchFlag").on("change", function (e) {
                    $("[name='licenseNameAllSearchFlag']").val($(this).prop("checked") ? "Y" : "N");
                });


            }
        };

        var fn = {
        	displayLicenseName : function(cellvalue, options, rowObject) {
                var link = $('<a>').prop({
                    class : 'urlLink',
                    href : 'javascript:',
                    text : cellvalue
                })

                link.attr('onclick', 'openDetailPage(' + rowObject.licenseId + ')');
                return link.prop('outerHTML');
        	},
            downloadExcel: function () {
                if (isMaximumRowCheck(totalRow)) {
                    var data = $('#licenseSearch').serializeObject();

                    // restrictions은 licenseMaster에서 String으로 선언되어 있기 때문에 gson변환시 에러가 발생
                    // array형으로 받을 수 있도록 다른이름에 재설정한다.
                    if (typeof data.restrictions !== "undefined") {
                        if (Array.isArray(data.restrictions)) {
                            data.arrRestriction = data.restrictions;
                        } else {
                            var restrictionArr = [];
                            restrictionArr.push(data.restrictions);
                            data.arrRestriction = restrictionArr;
                        }
                    }
                    data.restrictions = "";

                    $.ajax({
                        type: "POST",
                        url: '/exceldownload/getExcelPost',
                        data: JSON.stringify({"type": "license", "parameter": JSON.stringify(data)}),
                        dataType: 'json',
                        cache: false,
                        contentType: 'application/json',
                        success: function (data) {
                            if ("false" == data.isValid) {
                                if (data.validMsg == "overflow") {
                                    alertify.error(getMsgMaxRowCnt(), 0);
                                } else {
                                    alertify.error([[#{msg.common.valid2}]], 0);
                                }
                            } else {
                                window.location = '/exceldownload/getFile?id=' + data.validMsg;
                            }
                        },
                        error: function (data) {
                            alertify.error([[#{msg.common.valid2}]], 0);
                        }
                    });
                }
            },
            validationDate: function () {
                var flag = true;
                var cStart = $('input[name=cStartDate]').val().replace(/\-/g, '');
                var cEnd = $('input[name=cEndDate]').val().replace(/\-/g, '');
                var mStart = $('input[name=mStartDate]').val().replace(/\-/g, '');
                var mEnd = $('input[name=mEndDate]').val().replace(/\-/g, '');

                //둘다 비었을때
                if (!cStart && !cEnd) {

                } else {
                    if (!cStart) {
                        alert([[#{msg.license.confirm.startdate}]]);

                        flag = false;
                    } else {
                        alert([[#{msg.license.confirm.enddate}]]);

                        flag = false;
                    }
                }
                if (flag) {
                    if (!mStart && !mEnd) {

                    } else {
                        if (!mStart) {
                            alert([[#{msg.license.confirm.startdate}]]);

                            flag = false;
                        } else {
                            alert([[#{msg.license.confirm.enddate}]]);

                            flag = false;
                        }
                    }
                }

                return flag;
            },
            setGridParam: function () {
                var paramData = $('#licenseSearch').serializeObject();

                if (paramData.restrictions != null) {
                    paramData.restrictions = JSON.stringify(paramData.restrictions);
                    paramData.restrictions = paramData.restrictions.replace(/\"|\[|\]/gi, "");
                } else {
                    paramData.restrictions = "";
                }

                return paramData;
            },
        	onUpdateSuccess : function(json, status){
                loading.hide();
                if (json.resCd == '10'){
                    alertify.success([[#{msg.common.success}]]);
                } else {
                    alertify.error([[#{msg.common.valid2}]], 0);
                }
            }
        };

        var list = {
            load: function () {
                var rowStr = [[${@CommonFunction.getCoConstDefVal('DISP_PAGENATION_LIST_STR')}]];
                var rowList = rowStr.split(",");
                var rowNum = [[${@CommonFunction.getCoConstDefVal("DISP_PAGENATION_DEFAULT")}]];

                var colNameArr = ['ID', 'License Name (Identifier)', 'Identifier', 'License Type', 'Restriction', 'Obligation', 'Website', 'User Guide'];
                if ([[${@CommonFunction.isAdmin()}]]) {
                    colNameArr.push('Creator');
                    colNameArr.push('Created Date');
                    colNameArr.push('Modifier');
                    colNameArr.push('Modified Date');
                }
                var colModelArr = [];
                var colModelObj = {name: 'licenseId', index: 'licenseId', width: 40, align: 'center', sorttype: 'int'};
                colModelArr.push(colModelObj);
                colModelObj = {
                    name: 'licenseName',
                    index: 'licenseName',
                    width: 200,
                    align: 'left',
                    formatter: fn.displayLicenseName,
                    unformat: fn_grid_com.unformatter,
                };
                colModelArr.push(colModelObj);
                colModelObj = {name: 'shortIdentifier', index: 'shortIdentifier', width: 100, align: 'left', hidden: true};
                colModelArr.push(colModelObj);
                colModelObj = {name: 'licenseType', index: 'licenseType', width: 70, align: 'center'};
                colModelArr.push(colModelObj);
                colModelObj = {
                    name: 'restriction',
                    index: 'restriction',
                    width: 70,
                    align: 'center',
                    formatter: fn_grid_com.displayLicenseRestriction,
                    unformat: fn_grid_com.unformatter,
                    sortable: false,
                    search: false
                };
                colModelArr.push(colModelObj);
                colModelObj = {name: 'obligation', index: 'obligation', width: 65, align: 'left', sortable: false};
                colModelArr.push(colModelObj);
                colModelObj = {name: 'webpage', index: 'webpage', width: 60, align: 'left', formatter: 'link2'};
                colModelArr.push(colModelObj);
                colModelObj = {name: 'description', index: 'description', width: 150, align: 'left'};
                colModelArr.push(colModelObj);
                if ([[${@CommonFunction.isAdmin()}]]) {
                    colModelObj = {name: 'creator', index: 'creator', width: 80, align: 'center'};
                    colModelArr.push(colModelObj);
                    colModelObj = {
                        name: 'createdDate',
                        index: 'createdDate',
                        width: 75,
                        align: 'center',
                        formatter: 'date',
                        formatoptions: {srcformat: 'Y-m-d H:i:s.t', newformat: 'Y-m-d'}
                    };
                    colModelArr.push(colModelObj);
                    colModelObj = {name: 'modifier', index: 'modifier', width: 80, align: 'center'};
                    colModelArr.push(colModelObj);
                    colModelObj = {
                        name: 'modifiedDate',
                        index: 'modifiedDate',
                        width: 75,
                        align: 'center',
                        formatter: 'date',
                        formatoptions: {srcformat: 'Y-m-d H:i:s.t', newformat: 'Y-m-d'}
                    };
                    colModelArr.push(colModelObj);
                }

                $("#list").jqGrid({
                    url: '/license/listAjax',
                    datatype: 'json',
                    postData: initParam,
                    jsonReader: {
                        repeatitems: false,
                        id: 'licenseId',
                        root: function (obj) {
                            return obj.rows;
                        },
                        page: function (obj) {
                            return obj.page;
                        },
                        total: function (obj) {
                            return obj.total;
                        },
                        records: function (obj) {
                            return obj.records;
                        }
                    },
                    colNames: colNameArr,
                    colModel: colModelArr,
                    rowNum: rowNum,
                    rowList: rowList,
                    autowidth: true,
                    pager: '#pager',
                    gridview: true,
                    sortable: function (permutation) {
                    },
                    sortname: 'licenseId',
                    viewrecords: true,
                    sortorder: 'desc',
                    loadonce: false,
                    height: 'auto',
                    gridComplete: function () {

                        if (!data.existTooltip) {
                            $('<i class="fa fa-lg fa-info-circle icon-light-gray ml-2" data-toggle="tooltip" data-html="true" data-placement="bottom"></i>').appendTo($("#jqgh_list_obligation"))
                                .attr("title", data.tooltipCont).tooltip({
                                content: function () {
                                    return $(this).prop('title');
                                }
                            });
                            data.existTooltip = true;

                            // $('.urlLink').click(function(event) {
                            //     event.preventDefault();
                            //     var href = $(this).attr('href');
                            //     if (!/^https?:\/\//i.test(href)) {
                            //         href = 'http://' + href;
                            //     }
                            //     window.open(href, '_blank');
                            // });
// 					$.ajax({
// 						type: 'GET',
// 						url: '/system/processGuide/getProcessGuide',
// 						data: {"id":"License_List_License_Type"},
// 						success : function(data){
// 							if(data.processGuide){
// 								var contents = data.processGuide.contents;

// 								if(contents && contents.trim()) {
// 									$('<span class="iconSet help right">Help</span>').appendTo($("#jqgh_list_licenseType"))
// 									.attr("title", contents).tooltip({
// 										content: function () {
// 											return $(this).prop('title');
// 										}
// 									});

// 								}
// 							}
// 						}
// 					});

// 					// Restriction 툴팁 추가
// 					$.ajax({
// 						type: 'GET',
// 						url: '/system/processGuide/getProcessGuide',
// 						data: {"id":"License_List_Restriction"},
// 						success : function(data){
// 							if(data.processGuide){
// 								var contents = data.processGuide.contents;

// 								if(contents && contents.trim()) {
// 									$('<span class="iconSet help right">Help</span>').appendTo($("#jqgh_list_restriction"))
// 									.attr("title", contents).tooltip({
// 										content: function () {
// 											return $(this).prop('title');
// 										}
// 									});

// 								}
// 							}
// 						}
// 					});
                        }
                    },
                    loadComplete: function (result) {
                        totalRow = result.records;
                        // 헤더에 버튼 추가

                        if (totalRow == 0) {
                            var cStartDate = $("#cStartDate").val() || 0;
                            var cEndDate = $("#cEndDate").val() || 0;
                            var diffNum = +cStartDate - +cEndDate;

                            var mStartDate = $("#mStartDate").val() || 0;
                            var mEndDate = $("#mEndDate").val() || 0;
                            var diffNum2 = +mStartDate - +mEndDate;

                            if ((diffNum > 0 && cEndDate > 0) || (diffNum2 > 0 && mEndDate > 0)) {
                                alertify.alert([[#{msg.common.search.check.date}]], function () {
                                });
                            }
                        }
                    },
                    onSelectRow: function (id) {
                        $('#' + id + 'description').width(130).height(140);
                    },
                    // ondblClickRow: function (rowid, iRow, iCol, e) {
                    //     var rowData = $("#list").jqGrid('getRowData', rowid);
                    //     callCreateTabInFrame(rowData['licenseId'] + '_License', '/license/edit/' + rowData['licenseId'], 'license-edit_' + rowData['licenseId'], true);
                    // }
                });
            }
        };

        function displayUrl(cellvalue) {
            return "<a href=\"" + cellvalue + "\" class=\"urlLink\" target=\"_blank\">" + cellvalue + "</a>";
        }

        function openDetailPage(licenseId) {
            callCreateTabInFrame(licenseId + '_License', '/license/edit/' + licenseId, 'license-edit_' + licenseId, true);
        }
    </script>
</th:block>