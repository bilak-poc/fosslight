<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="contentScript">
  <script th:inline="javascript">
    let jsonData;
    let withStatus;
    let loadedInfo;
    let licenseData = [];
    let failLicense = [];
    let postData;
    let isClicked = false;
    let stringDataForValid = ['licenseName','licenseType','obligationNotificationYn','obligationDisclosingSrcYn',
      'shortIdentifier','description','licenseText', 'attribution', 'comment'];
    let inputStringDataForValid = ['licenseName','licenseType','obligationNotificationYn','obligationDisclosingSrcYn',
      'shortIdentifier'];
    let listDataForValid = ["licenseNicknames", "webpages"];
    let textAreaStringDataForValid = ['description', 'licenseText', 'attribution', 'comment'];
    let editColList = ['gridId', "licenseNicknames", "webpages", "licenseName", 'licenseType', 'obligationNotificationYn',
      'obligationDisclosingSrcYn', 'shortIdentifier','description','licenseText', 'attribution', 'comment'];
    let selectedIds = new Set()
    let accept1 = '';

    $(document).ready(function() {
      $('#bulkRestFile').uploadFile({
        url: '/license/csvFile',
        multiple: false,
        dragDrop: true,
        fileName: 'myfile',
        allowedTypes: accept1,
        sequential: true,
        sequentialCount: 1,
        dynamicFormData: function () {
            var data = { registFileId: $('#csvFileId').val(), tabNm: 'BULK' };
            return data;
        },
        onSuccess: function (files, data, xhr, pd) {
            $('#list').jqGrid('clearGridData');
            licenseData = [];
            if (data['res'] == true) {
                jsonData = data['value'];
                makeLicenseDTOList();
                stubColData();
                loading.hide();
            } else if (data['res'] == false) {
                showErrorMsg();
            } else {
                if (data['limitCheck'] == null) {
                    showErrorMsg();
                }
            }
        },
      });

      var target = $("#list");
      if (isClicked == false) {
        isClicked = true;

        $("#btn").click(() => {
          LicenseBulkGridStatusMessageManager.cleanStatusMessages();
          LicenseBulkGridWarningMessageUtil.cleanMessages();
          target.jqGrid('saveRow', _mainLastsel);

          // load all rows in grid
          var mainData = target.jqGrid('getRowData');

          dataValidCheck(mainData)
          makePostData()

          $.ajax({
            type: "POST",
            contentType: 'application/json',
            url: "/license/bulkRegAjax",
            data: JSON.stringify(postData),
            cache: false,
            dataType: "json",
            success: (data) => {
              failLicense = []
              _mainLastsel = -1;
              if (data['res'] == true && data['value'] != []) {
                loadedInfo = data['value'];

                LicenseBulkGridStatusMessageManager.setStatusMessages(loadedInfo);
                LicenseBulkGridWarningMessageUtil.call();

                alertify.alert('<spring:message code="msg.common.success" />', function () {
                });
              } else if (data['res'] == false) {
                showErrorMsg();
                LicenseBulkGridWarningMessageUtil.setMessagesToCurPage();
              }
            },
            error: (e) => {
              LicenseBulkGridWarningMessageUtil.setMessagesToCurPage();
            }
          })
        })
      }

      bulkReg_grid.load();
    });

    const bulkReg_grid = {
      load : function () {
        $("#list").jqGrid({
          datatype: "local",
          data : jsonData,
          colNames:['gridId', 'License Name','License Type','Notice','Source Code','SPDX Short Identifier','Nickname',
            'Website for the license','User Guide',  'License Text', 'Attribution','Comment', 'Status'],
          colModel: [
            { name: 'gridId', index: 'gridId', width: 75, key:true, hidden: true, editable:false},
            { name: 'licenseName', index: 'License Name', width: 200, align: 'left', editable:false},
            { name: 'licenseType', index: 'License Type', width: 200, align: 'left', editable:false},
            { name: 'obligationNotificationYn', index: 'Notice', width: 75, align: 'left', editable:false},
            { name: 'obligationDisclosingSrcYn', index: 'Source Code', width: 75, align: 'left', editable:false},
            { name: 'shortIdentifier', index: 'SPDX Short Identifier', width: 300, align: 'left', editable:false},
            { name: 'licenseNicknames', index: 'Nickname', width: 300, align: 'left', editable:false},
            { name: 'webpages', index: 'Website for the license', width: 200, align: 'left', editable:false},
            { name: 'description', index:'User Guide', width: 250, align: 'left', editable:false, edittype:"textarea"},
            { name: 'licenseText', index:'License Text', width: 150, align: 'left', editable:false, edittype:"textarea"},
            { name: 'attribution', index:'Attribution', width: 150, align: 'left', editable:false, edittype:"textarea"},
            { name: 'comment', index:'comment', width: 150, align: 'left', editable:false, edittype:"textarea"},
            { name: 'status', index:'status', width: 150, align: 'left'}
          ],
          viewrecords: true,
          rowNum: [[${@CommonFunction.getCoConstDefVal('DISP_PAGENATION_DEFAULT')}]],
          rowList: [[${@CommonFunction.getCoConstDefVal('DISP_PAGENATION_LIST_STR')}]],
          autowidth: true,
          gridview: true,
          height: 'auto',
          pager: '#pager',
          autoencode: true,
          editurl:'clientArray',
          recordpos:'right',
          toppager:true,
          loadonce:false,
          cellsubmit : 'clientArray',
          ignoreCase: true,
          multiselect: true,

          /** check rows seleted when move page*/
          loadComplete: function(data) {
            _mainLastsel = -1;
            selectMarkWhenPageChange();
            makeBackGroundColor();
            LicenseBulkGridWarningMessageUtil.setMessagesToCurPage();
          },
          ondblClickRow: function(rowid,iRow,iCol,e) {
            if(rowid) {
              if (rowid != _mainLastsel) {
                $("#list").jqGrid('saveRow', _mainLastsel);
                LicenseBulkGridWarningMessageUtil.setMessageToRow(_mainLastsel);
              }
              LicenseBulkGridWarningMessageUtil.cleanMessageOfRow(rowid);
              editable()
              $("#list").jqGrid('editRow', rowid);
              _mainLastsel = rowid;
              var nextCol = $("#list").jqGrid('getGridParam', 'colModel')[iCol].name
              var nextRow = rowid
              $('#' + nextRow + "_" + nextCol).focus();
            }
          },
          /** select or not each row */
          onSelectRow: function(id){
            selectOrUnselect(id);
          },
          /** select or not all rows */
          onSelectAll: function(aRowids, status) {
            (status) ? selectAllPage() : unselectAllPage();
          },
          /** save data edited when move page */
          onPaging: function() {
            LicenseBulkGridWarningMessageUtil.cleanMessages();

            $("#list").jqGrid('saveRow', _mainLastsel);

            var mainData = $("#list").jqGrid('getRowData');

            dataValidCheck(mainData)
          }
        });

        let accept1 = '';
        let acceptList = [[${@CoCodeManager.getCodes(@CommonFunction.getCoConstDefVal('CD_FILE_ACCEPT'))}]];

        acceptList.forEach((file) => {
          if (file === '11') {
            accept1 = [[ ${@CoCodeManager.getCodeExpString(@CommonFunction.getCoConstDefVal('CD_FILE_ACCEPT', file))} ]];
          }
        });
      }
    }

    function selectMarkWhenPageChange() {
      for(let id of $("#list").jqGrid("getDataIDs")) {
        if(selectedIds.has(id)) {
          selectedIds.delete(id);
          $("#list").jqGrid("setSelection", id);
        }
      }
    }

    function refreshGrid($grid, results) {
      $grid.jqGrid('clearGridData')
              .jqGrid('setGridParam', { data: results })
              .trigger('reloadGrid', [{ page: 1}]);
    }

    /**
     * change background color of failed oss row
     * */
    function makeBackGroundColor(){
      for (const failLicenseGridId of failLicense) {
        $("#list").jqGrid("setRowData", failLicenseGridId, false, {'background' : "rgba(255, 0, 0, 0.3)"});
      }
    }

    const LicenseBulkGridStatusMessageManager = {
      cleanStatusMessages: function () {
        $("#list").jqGrid("getGridParam", "data").forEach(row => {
          row.status = ""
        });
      },
      setStatusMessages: function (results) {
        for (const result of results){
          $("#list").jqGrid("getLocalRow", result.gridId).status = result.msg;
          if (!result.status) {
            failLicense.push(result.gridId);
          }
        }
        $("#list").trigger('reloadGrid', [{ page: 1}]);
      }
    };

    const LicenseBulkGridWarningMessageUtil = (function() {
      let validData = {};
      const gridStr = "list";
      return {
        call: function () {
          this.cleanMessages();
          return this.requestMessages()
                  .then(response => {
                    console.log(response)
                    this.setValidData(response);
                    this.setMessagesToCurPage();
                  });
        },
        requestMessages: function() {
          return $.ajax({
            type: "POST",
            contentType: 'application/json',
            url: "/license/bulkValidation",
            data: JSON.stringify(this.requestBody()),
            cache : false,
            dataType: "json"
          })
        },
        requestBody: function() {
          licenseData.forEach((row) => {
            stringDataForValid.forEach((strData) => {
              if(row[strData] === null || row[strData] === undefined)
                row[strData] = "";
            })
            listDataForValid.forEach((listData) => {
              if(row[listData] === null || row[listData] === undefined)
                row[listData] = [];
            })
          })
          return licenseData;
        },
        setValidData: (response) => { validData = response.validData; },
        setMessagesToCurPage: function () {
          gridValidMsgNew(validData, gridStr, "NORMAL");
        },
        cleanMessages: function() { gridCleanErrMsg(gridStr); },
        cleanMessageOfRow: function(rowId) { cleanErrMsg(gridStr, rowId) },
        setMessageToRow: function(rowId) { gridValidMsgRowId(validData, gridStr, rowId); }
      }
    })();


  </script>
</th:block>
</html>