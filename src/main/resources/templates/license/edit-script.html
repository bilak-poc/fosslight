<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="contentScript">
    <script th:inline="javascript">
        var totalRow = 0;
        //const G_ROW_CNT = "*{gRowCnt}";

        $(window).load(function () {
            lic_edit_data.init();

            if($('input[name=licenseId]').val()) {
                lic_edit_cmt.getCommentList();
            }
        });

        const lic_edit_data = {
            detail : [[${ detail }]],
            init: function () {
                $('#licenseTypeSelect').select2({
                    placeholder: "License Type",
                    allowClear: true,
                });

                $("#restrictionSelect").select2({
                    placeholder: "Restriction",
                    allowClear: true,
                });

                $("[name='commentInput']").summernote();

                $("[name='addTagButton']").click(function (e) {
                    const elId = this.id;
                    appendSingleTag(e, elId);

                    // $("[name='deleteTagButton']").on("click", function () {
                    //     $(this).closest(".tag-container").remove();
                    // });
                });

                //save license
                $("#save").on('click',function(){
                    alertify.confirm(String([[ #{msg.common.confirm.save} ]]), function (e) {
                        if (e) {
                            lic_edit_fn.registSubmit();
                        } else {
                            return false;
                        }
                    });
                });

                //delete license
                $('#delete').on('click', function(){
                    var editorVal = CKEDITOR.instances.editor.getData();

                    if(editorVal == "") {
                        alertify.alert(String([[ #{msg.license.confirm.delete.required.comment} ]]), function(){});
                        return false;
                    }

                    alertify.confirm(String([[ #{msg.license.confirm.delete} ]]), function (e) {
                        if (e) {
                            $('input[name=comment]').val(editorVal);
                            deleteSubmit();
                        } else {
                            return false;
                        }
                    });
                });
            }
        }

        const lic_edit_fn = {
            registSubmit: function () {
                $("#licenseForm").ajaxForm({
                    url :"/license/validation",
                    type : 'POST',
                    dataType:"json",
                    cache : false,
                    success: lic_edit_fn.onValidSuccess,
                    error : lic_edit_fn.onError
                }).submit();
            },
            onValidSuccess: function (json, status) {
                if (json.isValid == 'false') {
                    lic_edit_fn.createValidMsgComplex(json);
                    alertify.error(String([[ #{msg.common.valid} ]]), 0);
                } else if (json.isValid == 'true') {
                    loading.show();

                    var editorVal = $('#commentInput').summernote('code');
                    $('input[name=comment]').val(replaceWithLink(editorVal));

                    var pData = $('#licenseForm').serializeObject();

                    if (pData.restrictions != null) {
                        pData.restrictions = JSON.stringify(pData.restrictions);
                        $('input[name=restriction]').val(pData.restrictions.replace(/\"|\[|\]/gi, ""));
                        console.log("restric ::" + pData.restrictions);
                    } else {
                        $('input[name=restriction]').val('');
                    }

                    $("#licenseForm").ajaxForm({
                        url: "/license/saveAjax",
                        type: 'POST',
                        dataType: "json",
                        cache: false,
                        success: lic_edit_fn.onRegistSuccess,
                        error: lic_edit_fn.onError
                    }).submit();
                }
            },
            onRegistSuccess: function(json, status){
                loading.hide();

                if(json.resCd == '10') {
                    alertify.alert(String([[ #{msg.common.success} ]]), function(){
                        callDeleteTabInFrame("license-edit_" + json.licenseId);
                        callReloadTabInframe("/license/list", "license-list");
                    });
                } else {
                    alertify.error(String([[ #{msg.common.valid2} ]]), 0);
                }
            },
            onError: function(data, status){
                alertify.error(String([[ #{msg.common.valid2} ]]), 0);
            },
            createValidMsgComplex: function(msgData){
                lic_edit_fn.hideErrMsg();

                $.each(msgData,function(key,value) {
                    if("isValid" != key && "validMsg" != key) {
                        if(key.indexOf(".") > -1 ){
                            var seqSuffix = key.split(".");
                            var targetId = seqSuffix[1] + "_" + seqSuffix[0];

                            if(seqSuffix[0]=='licenseNicknames'){
                                $('input[name=licenseNicknames]:eq('+(Number(seqSuffix[1])-1)+')').focus().parent().next("span.retxt").html(value).show();
                            }

                            if($('input[id='+targetId+']').length > 0) {
                                $('input[id='+targetId+']').focus().after(makeErrMsg(value)).show();
                            } else if($('textarea[id='+targetId+']').length > 0) {
                                $('textarea[id='+targetId+']').focus().after(makeErrMsg(value)).show();
                            } else if($('select[id='+targetId+']').length > 0) {
                                $('select[id='+targetId+']').focus().after(makeErrMsg(value)).show();
                            }
                        } else {
                            if(key == 'licenseNicknames'){
                                $('input[name=licenseNicknames]').focus().parent().next("span.retxt").html(value).show();
                            }

                            if(key == 'validMsgModelList') {
                                $('#validMsgModelList').html(value).show();
                            }

                            if($('input[name='+key+']').length > 0) {
                                $('input[name='+key+']').focus().next("span.retxt,div.retxt").html(value).show();
                            } else if($('textarea[name='+key+']').length > 0) {
                                $('textarea[name='+key+']').focus().next("span.retxt,div.retxt").html(value).show();
                            } else if($('select[name='+key+']').length > 0) {
                                $('select[name='+key+']').focus().parent().siblings("span.retxt,div.retxt").html(value).show();
                            }
                        }
                    }
                });
            },
            hideErrMsg: function () {
                $("div.retxt").hide();
                $("span.retxt").hide();
            }
        };

        const lic_edit_cmt = {
            getCommentList: function () {
                const data = {
                    referenceId: lic_edit_data.detail.licenseId,
                    referenceDiv: 'license'
                };

                getAjaxData(data, "/comment/getCommentList", 'html',
                    function (res) {
                        $('#commentAreaFragment').replaceWith(res);
                        $("[name ='commentModifyBtn']").on("click", function (e){
                            e.preventDefault();
                            lic_edit_cmt.handleModalOpen($(this))
                        })
                        $("[name ='commentDeleteBtn']").on("click", function (e){
                            e.preventDefault();
                            lic_edit_cmt.deleteComment($(this))
                        })
                },
                    function (xhr, ajaxOptions, thrownError) {
                        alertify.error(String([[ #{msg.common.valid2} ]]), 0);
                });
            },
            deleteComment: function (el) {
                console.log(el)
                const commId = el.attr('data-commId');
                if (!confirm("Are you sure you want to delete this comment?")) {
                    return;
                }

                $.ajax({
                    url: "/comment/deleteComment",
                    type: 'POST',
                    dataType: 'json',
                    cache: false,
                    data: {'commId': commId},
                    success: function (data) {
                        alertify.error(String([[#{msg.common.success}]]));
                        lic_edit_cmt.getCommentList();
                    },
                    error: function () {
                        alertify.error(String([[#{msg.common.valid2}]]), 0);
                    }
                });
            },
            handleModalOpen: function (el) {
                const commId = el.attr('data-commId');
                const contents = el.attr('data-contents');

                $("#modifiedCommentId").val(commId);
                $('#modifiedCommentCont').summernote('code', contents);
                $("#modifiedCommentSaveBtn").on("click", function (e) {
                    e.preventDefault();
                    lic_edit_cmt.editComment();
                })
            },
            editComment: function () {
                const commId = $("#modifiedCommentId").val();
                const referenceId = $('input[name=licenseId]').val();
                const contents = $('#modifiedCommentCont').summernote('code');
                const param = {
                    'commId': commId,
                    'contents': contents,
                    'referenceDiv': '30',
                    'referenceId': referenceId
                };

                $.ajax({
                    url: "/comment/updateComment",
                    type: 'POST',
                    dataType: 'json',
                    cache: false,
                    data: param,
                    success: function (json) {
                        alertify.success(String([[ #{msg.common.success} ]]), 0);
                    },
                    error: function () {
                        alertify.error(String([[ #{msg.common.valid2} ]]), 0);
                    },
                    complete: function () {
                        lic_edit_cmt.getCommentList();
                    }
                });
                return false;
            }
        }


    </script>
</th:block>