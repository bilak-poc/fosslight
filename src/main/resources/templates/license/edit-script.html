<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="contentScript">
    <script th:inline="javascript">
    	var userRole = [[${sessUserInfo.authority}]];
    	var commentsParam = {referenceDiv : 'license'};
    
        $(window).load(function () {
            lic_edit_data.init();
            
            showHelpLink("License_Edit_Info", "heplLink_licenseEditInfo");
        });
        
        const lic_edit_data = {
            detail : [[${ detail }]],
            init: function () {
                $('.select2').select2();

                $("[name='commentInput']").summernote({
                    height: 100,
                    callbacks: {
                        onInit: function() {
                            $("[name='commentInput']").summernote('focus');

                            var content = $(this).summernote('code');
                            if (content === '<p><br></p>') {
                                $(this).summernote('code', '');
                            }
                        }
                    }
                });

                $('[name=\'commentInput\']').unbind('keydown').bind('keydown', function (event) {
                    var doPrevent = false;

                    if (event.keyCode === 8 && $('[name=\'commentInput\']').html() === '<p><br></p>'){
                        event.preventDefault();
                    }
                });

                $("#licenseNicknames").on('click', function(){
                	let licenseNicknameHtml = '	<div class="col-md-2" style="margin-bottom: 0.5rem;">';
            		licenseNicknameHtml += '		<div class="form-group mb-0" >';
            		licenseNicknameHtml += '			<input class="form-control" type="type" name="licenseNicknames" value="' + $("#input_licenseNicknames").val() + '" />';
            		licenseNicknameHtml += '			<button type="button" class="btn btn-tool xbox" onclick="fn.removeTag(this)"><i class="fas fa-times"></i></button>';
            		licenseNicknameHtml += '			<span class="retxt"></span>';
            		licenseNicknameHtml += '		</div>';
            		licenseNicknameHtml += '	</div>';
            		
            		$(".multiTxtSet").append(licenseNicknameHtml);
            		$("#input_licenseNicknames").val("");
                });

                $("#webpageAdd").on('click', function(){
                	let webpageHtml = '		<div class="form-group mb-0" style="margin-bottom: 0.5rem;">';
                	webpageHtml 	+= '		<input class="form-control" type="type" name="webpages" value="' + $("#input_webpages").val() + '" />';
                	webpageHtml 	+= '		<button type="button" class="btn btn-tool xbox" onclick="fn.removeTag(this)"><i class="fas fa-times"></i></button>';
                	webpageHtml 	+= '		<span class="retxt"></span>';
                	webpageHtml 	+= '	</div>';
            		
            		$(".multiWebPageSet").append(webpageHtml);
            		$("#input_webpages").val("");
                });
                
                //save license
                $("#save").on('click',function(){
                    alertify.confirm([[ #{msg.common.confirm.save} ]], function (e) {
                        if (e) {
                            lic_edit_fn.registSubmit();
                        } else {
                            return false;
                        }
                    });
                });

                //delete license
                $('#delete').on('click', function(){
                    var editorVal = $("#commentInput").summernote('code');

                    if ("" == editorVal) {
                        alertify.alert([[ #{msg.license.confirm.delete.required.comment} ]], function(){});
                        return false;
                    }

                    alertify.confirm([[#{msg.license.confirm.delete}]], function (e) {
                        if (e) {
                            $('input[name=comment]').val(editorVal);
                            deleteSubmit();
                        } else {
                            return false;
                        }
                    });
                });

              	//고지서 체크 안한상태에서 소스공개 체크 시 고지서 자동체크
    			$('input[name=obligationDisclosingSrcYn]').on('click', function(){
    				var checked1 = $(this).attr('checked');
    				var checked2 = $('input[name=obligationNotificationYn]').attr('checked');
    				if (checked1 && !checked2){
    					$('input[name=obligationNotificationYn]').trigger('click');
    				}
    			});
    			
    			$('select[name=licenseType]').on('change', function(){
    				// The others be set to usable.
    				$(".oblicationChk").attr("disabled", false);
    				
    				// Extracted function for 'Needs Check' check box event. hk-cho
    				setObligationCheckBox($(this).val());
    			});
                
                if (lic_edit_data.detail != null) {
                	commentsParam["referenceId"] = lic_edit_data.detail.licenseId;
                }
                
                commentsParam["height"] = $(window).height() - 120;
    			fn_comment.getCommentList(commentsParam);
            }
        }

        const lic_edit_fn = {
            registSubmit: function () {
            	$("#licenseType option[value='']").removeAttr('disabled');
            	
                $("#licenseForm").ajaxForm({
                    url :"/license/validation",
                    type : 'POST',
                    dataType:"json",
                    cache : false,
                    success: lic_edit_fn.onValidSuccess,
                    error : onError
                }).submit();
            },
            onValidSuccess: function (json, status) {
                if (json.isValid == 'false') {
                    createValidMsgComplex(json);
                    alertify.error([[ #{msg.common.valid} ]], 0);
                } else if (json.isValid == 'true') {
                    loading.show();

                    var editorVal = $('#commentInput').summernote('code');
                    $('input[name=comment]').val(replaceWithLink(editorVal));

                    var pData = $('#licenseForm').serializeObject();

                    if (pData.restrictions != null) {
                        pData.restrictions = JSON.stringify(pData.restrictions);
                        $('input[name=restriction]').val(pData.restrictions.replace(/\"|\[|\]/gi, ""));
                    } else {
                        $('input[name=restriction]').val('');
                    }

                    $("#licenseForm").ajaxForm({
                        url: "/license/saveAjax",
                        type: 'POST',
                        dataType: "json",
                        cache: false,
                        success: lic_edit_fn.onRegistSuccess,
                        error: onError
                    }).submit();
                }
            },
            onRegistSuccess: function(json, status){
                loading.hide();
                $('#commentInput').summernote('code', '');
                
                if (json.resCd == '10') {
                	alertify.alert([[ #{msg.common.success} ]], function(){
                    	deleteTabInFrame('/license/edit/' + json.licenseId);
        				reloadTabInframe('/license/list');
                    });
                } else {
                    alertify.error(String([[ #{msg.common.valid2} ]]), 0);
                }
            }
        };

        var fn = {
        	removeTag : function(obj) {
        		$(obj).parent().parent().remove();
        	},
        	closeAlertifyView : function() {
        		$(".ajs-close").trigger("click");
        	},
        	handleUserCommentPopupOpen : function () {
				// 코멘트 팝업
		        const param = {
		            "referenceDiv" : [[${@CommonFunction.getCoConstDefVal('CD_DTL_COMMENT_LICENSE_USER')}]],
		            "referenceId" : lic_edit_data.detail.licenseId
		        }
				
		        getAjaxJsonData(param, "/comment/getDivUserComment", "html", function (res) {
		        	if (!alertify.editDialog){
						alertify.dialog('editDialog', function() {
							return {
								setup: function() {
									var settings = alertify.confirm().settings;
								
									for (var prop in settings) {
										this.settings[prop] = settings[prop];
									}
								
									var setup = alertify.confirm().setup();
									setup.buttons = [];
									setup.focus.element = 0;
								
									return setup;
								},
						    	hooks: {
						    		onshow: function() {
						        		this.elements.dialog.style.maxWidth = 'none';
						          		this.elements.dialog.style.width = '700px';
						        	}
								}
							};
						}, false, 'confirm');
		    		}
				
					alertify.editDialog(res);
		      	},
		       	null,
		      	function () {
		         	$("#modifiedCommentInPjtEditor").summernote({
		            	height: 180,
		              	callbacks: {
		                 	onInit: function () {
		                      	$(this).summernote('code', $("#userContents").val());
		                 	}
		              	}
		           	});
		     	});
			},
			sendEditor : function(type){
				//코멘트 저장
				var editorVal = replaceWithLink($("#modifiedCommentInPjtEditor").summernote('code'));
				
				if(!editorVal || editorVal == "") {
					alertify.alert([[#{msg.project.enter.comment}]], function(){});
					
					return false;
				}
				
				var param = {referenceId : lic_edit_data.detail.licenseId, referenceDiv :[[${@CommonFunction.getCoConstDefVal('CD_DTL_COMMENT_LICENSE')}]], contents : replaceWithLink(editorVal), mailSendType : type};
				
				$.ajax({
					url : '/project/sendComment',
					type : 'POST',
					dataType : 'json',
					cache : false,
					data : param,
					success : function(json){
						if (json.isValid == 'false'){
							alertify.error([[#{msg.common.valid2}]], 0);
						} else {
							alertify.success([[#{msg.project.sent.comments.success}]]);
							$("#modifiedCommentInPjtEditor").summernote('code', '');
							$("#userContents").val('');
							$('.ajs-close').trigger("click");
		                    fn_comment.getCommentList(commentsParam);
		                    
		                    if (_popupComment == null || _popupComment.closed) {
		                    } else {
		                    	_popupComment.callbackFunction();
		                    }
						}
					},
					error : function(){
						alertify.error([[#{msg.common.valid2}]], 0);
					}
				});
			},
			saveEditor : function(){
				//코멘트 임시저장
				var editorVal = replaceWithLink($("#modifiedCommentInPjtEditor").summernote('code'));
				var register = [[${sessUserInfo.userId}]];
				var param = {referenceId : lic_edit_data.detail.licenseId, referenceDiv :[[${@CommonFunction.getCoConstDefVal('CD_DTL_COMMENT_LICENSE_USER')}]], contents : editorVal};
				
				$.ajax({
					url : '/project/saveComment',
					type : 'POST',
					dataType : 'json',
					cache : false,
					data : param,
					success : function(json){
						if(json.isValid == 'false'){
							alertify.error([[#{msg.common.valid2}]], 0);
						} else {
							alertify.success([[#{msg.common.success}]]);
							$("#userContents").val(editorVal);
							$('.ajs-close').trigger("click");
						}
					},
					error : function(){
						alertify.error([[#{msg.common.valid2}]], 0);
					}
				});
			}
        }
        
        var fn_comment = {
        	callbackFunction : function () {
            	fn_comment.getCommentList(commentsParam);
            },
            getCommentList : function(param){
            	$.ajax({
               		url : '/comment/getCusCommentList',
                   	type : 'GET',
                   	dataType : 'html',
                   	cache : false,
                   	data : param,
                   	success : function(res){
                   		if (typeof param.height !== undefined) {
    						$(".comment-card-body").attr("style", "max-height:" + param.height + "px; overflow-y: auto;");
    					}
                   		$("#commentList").empty();
    					$("#commentList").html(res);
                   	},
                   	error : function(xhr, ajaxOptions, thrownError){
                   		alertify.error([[#{msg.common.valid2}]], 0);
                   	}
               	});
            },
            getMoreCommentsList : function() {
        		commentsParam["moreFlag"] = "Y";
        		fn_comment.getCommentList(commentsParam);
        	},
        	editComments : function(_commId, _referenceDiv, _referenceId) {
        		$.ajax({
            		url : '/comment/getEditPopup',
        			type : 'POST',
        			data : {'commId' : _commId},
        			dataType : 'html',
        			cache : false,
        			success : function(res){
        				if(!alertify.editComments){
        					alertify.dialog('editComments', function() {
        						return {
        							setup: function() {
        								var settings = alertify.confirm().settings;
        							
        								for (var prop in settings) {
        									this.settings[prop] = settings[prop];
        								}
        								
        								var setup = alertify.confirm().setup();
        								setup.buttons = [];
        								setup.focus.element = 1;
        							
        								return setup;
        							},
        					    	hooks: {
        					    		onshow: function() {
        					        		this.elements.dialog.style.maxWidth = 'none';
        					          		this.elements.dialog.style.width = '750px';
        					        	}
        							}
        						};
        					}, false, 'alert');
                   		}
        				
        				alertify.editComments(res).set('title', 'Edit Comments');
        				$("#updateComments").attr("onclick", "fn_comment.updateComments("+_commId+", "+_referenceDiv+", "+_referenceId+")");
        				$("#commentEdit").summernote({minHeight: 200, maxHeight: 800, lang: "ko-KR"});
        			}
            	});
        	},
        	updateComments : function (_commId, _referenceDiv, _referenceId) {
        		var summernoteVal = $("#commentEdit").summernote('code');
        		if ("" == summernoteVal) {
        			alertify.alert("Please enter a comment", function(){});
        			return false;
        		} else {
        			var param = {commId : _commId, contents : replaceWithLink(summernoteVal), referenceDiv: _referenceDiv, referenceId: _referenceId};
        			$.ajax({
        				url : '/comment/updateComment',
        				type : 'POST',
        				dataType : 'json',
        				cache : false,
        				data : param,
        				success : function(json){
        					alertify.success([[#{msg.common.success}]]);
        					fn.closeAlertifyView();
        					fn_comment.getCommentList(commentsParam);
        				},
        				error : function(){
        					alertify.error([[#{msg.common.valid2}]], 0);
        				}
        			});
        		}
        	},
        	deleteComments : function (_commId) {
        		alertify.confirm("Are you sure you want to delete this comment?", function (e) {
        			if (e) {
        				$.ajax({
        					url : '/comment/deleteComment',
        					type : 'POST',
        					dataType : 'json',
        					cache : false,
        					data : {'commId' : _commId},
        					success : function(data){
        						alertify.success([[#{msg.common.success}]]);
        						fn.closeAlertifyView();
        						fn_comment.getCommentList(commentsParam);
        					},
        					error : function(){
        						alertify.error([[#{msg.common.valid2}]], 0);
        					}
        				});
        			} else {
        				return false;
        			}
        		});
        	},
        	closeAlertifyView : function () {
        		fn.closeAlertifyView();
        	},
    		activateCommentArea : function () {
    			var commentRow = $("#commentList .card-body").length;
    			
    			// change tab area
    			if (!$(".editInfoCommentArea").is(":visible")) {
    				$(".editInfoAreaTop").hide();
    				$(".editInfoAreaBottom").hide();
    				$(".editInfoArea").removeClass("col-md-10");
    				$(".editInfoArea").addClass("col-lg-9");
    				$(".editInfoCommentArea").show();
    				resizingJqGidSet();
    			} else {
    				$(".editInfoAreaTop").show();
    				$(".editInfoArea").removeClass("col-lg-9");
    				$(".editInfoArea").addClass("col-md-10");
    				$(".editInfoAreaBottom").show();
    	 			$(".editInfoCommentArea").hide();
    	 			resizingJqGidSet();
    			}
    		},
    		showCommentHistory : function () {
    			var _rDiv = [[${@CommonFunction.getCoConstDefVal('CD_DTL_COMMENT_LICENSE')}]];
    	        openCommentHistory('/comment/popup/license/' + _rDiv + '/' + [[${detail.licenseId}]]);
    		}
        }
        
        function deleteSubmit(){
    		$("#licenseForm").ajaxForm({
    			url :'/license/delAjax',
                type : 'POST',
                dataType:"json",
                cache : false,
    	        success:onDeleteSuccess,
                error : onError
    	    }).submit();
    	}
        
        function onDeleteSuccess(json, status){
    		var licenseId = $('input[name=licenseId]').val();
    		
    		if (json.isValid == 'false') {
    			alertify.alert(json.validMsg, function(){});
    		} else {
    			alertify.alert([[#{msg.common.success}]] ,function(){
    				if (licenseId) {
    					deleteTabInFrame('/license/edit/'+licenseId);			
    				} else {
    					deleteTabInFrame('/license/edit');
    				}
    				reloadTabInframe('/license/list');
    			});
    		}
    	}
        
        function onError(data, status){
    		alertify.error([[#{msg.common.valid2}]], 0);
        }
        
        function setObligationCheckBox(type){
    		if (type == [[${@CoCodeManager.getCodes(@CommonFunction.getCoConstDefVal('CD_LICENSE_TYPE'))[2]}]]) {
    			$('input[name=obligationNotificationYn]').prop('checked', true);
    			$('input[name=obligationDisclosingSrcYn]').prop('checked', true);
    		} else if (type == [[${@CoCodeManager.getCodes(@CommonFunction.getCoConstDefVal('CD_LICENSE_TYPE'))[1]}]]) {
    			$('input[name=obligationNotificationYn]').prop('checked', true);
    			$('input[name=obligationDisclosingSrcYn]').prop('checked', true);
    		} else if (type == [[${@CoCodeManager.getCodes(@CommonFunction.getCoConstDefVal('CD_LICENSE_TYPE'))[0]}]]) {
    			$('input[name=obligationNotificationYn]').prop('checked', true);
    			$('input[name=obligationDisclosingSrcYn]').prop('checked', false);
    		}
    	};
    </script>
</th:block>