<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="commentAreaFragment">
    <div>
        <div class="row" id="commentAreaFragment">
            <th:block th:if="${!#lists.isEmpty(commentList)}">
                <div class="col-md-12">
                    <table class="table">
                        <tbody>
                        <th:block th:each="comment, status : ${commentList}">
                            <tr>
                                <td>
                                    <div class="post">
                                        <div class="user-block">
									<span class="username">
									  <a href="#">[[ ${comment.loginUserName} ]]</a>
									</span>
                                            <span class="description ml-0" th:text="${comment.createdDate}"></span>
                                        </div>
                                        <p th:utext="${comment.contents}">
                                        </p>
                                    </div>
                                </td>
                                <td class="text-right py-0 align-middle">
                                <td class="text-right py-0 align-middle">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn btn-default" type="button" th:data-commId="${comment.commId}" name="commentModifyBtn">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                        <button class="btn btn-lg-red" th:data-commId="${comment.commId}" name="commentDeleteBtn" type="button">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </th:block>
                        </tbody>
                    </table>
                </div>
            </th:block>
            <th:block th:if="${#lists.isEmpty(commentList)}">
                <div class="col-md-12">
                    <strong class="text-lg-gray">No comments were registered.</strong>
                </div>
            </th:block>
        </div>
    </div>
    <script th:inline="javascript">
        $(document).ready(function() {
            const commentCnt = [[ ${commentListCnt} ]];
            const moreYn = [[ ${moreYn} ]];

            if(commentCnt > 5 && !moreYn) {
                $("#moreListDiv").show();
            }else{
                $("#moreListDiv").hide();
            }
        });
    </script>
</th:block>
<th:block th:fragment="commentHistoryAreaFragment">
    <th:block th:replace="fragments/detail-script :: detailScriptFragment"></th:block>
    <div class="custom-layout" id="commentHistoryAreaFragment">
        <section class="content-header">
            <div class="container-fluid">
                <div class="row">
                    <th:block
                            th:if="${#strings.equals(basicInfo.referenceDiv, 'prj') || #strings.equals(basicInfo.referenceDiv, '3rd')}">
                        <div class="col-sm-6 text-left mt-3">
                            <span class="description-percentage text-dark-gray">
                                <b>[<span th:text="${project.prjId}"></span>]<span class="ml-1"
                                                                                   th:text="${project.prjName}"></span></b>
                            </span>
                            <span class="text-lg-gray text-smaller mx-1">
                                    <span class="badge badge-primary text-md" style="width: 1.5rem">B</span>
                                    <span class="badge badge-warning text-md" style="width: 1.5rem">I</span>

                                <span class="badge badge-info text-md callOpener"
                                      style="width: 1.5rem; cursor: pointer;" id="packaging"
                                      th:if="${#strings.equals(project?.identificationStatus, 'CONF') && not #strings.equals(project?.verificationStatus, 'NA')}">P</span>
                                <span class="badge badge-danger text-md callOpener"
                                      style="width: 1.5rem; cursor: pointer;" id="distribution"
                                      th:if="${#strings.equals(project?.verificationStatus, 'CONF') && not #strings.equals(project?.destributionStatus, 'NA')}">D</span>
                            </span>
                        </div>
                    </th:block>
                    <div class="col-sm-6">
                        <form class="mb-0" id="commentSchForm"
                              onkeydown="javascript: if(event.keyCode==13) { fn_commemt.getCommentList(); return false; }">
                            <div class="row mt-2">
                                <div class="col-4">
                                    <select class="custom-select float-right" data-placeholder="Section"
                                            id="schReferenceDiv" name="schReferenceDiv">
                                        <option disabled hidden selected>Section</option>
                                        <option th:value="${@CommonFunction.getCoConstDefVal('CD_DTL_COMMENT_PROJECT_HIS')}">
                                            [[
                                            ${@CoCodeManager.getCodeString(@CommonFunction.getCoConstDefVal('CD_COMMENT_DIVISION'),
                                            @CommonFunction.getCoConstDefVal('CD_DTL_COMMENT_PROJECT_HIS'))} ]]
                                        </option>
                                        <option th:value="${@CommonFunction.getCoConstDefVal('CD_DTL_COMMENT_IDENTIFICAITON_HIS')}">
                                            [[
                                            ${@CoCodeManager.getCodeString(@CommonFunction.getCoConstDefVal('CD_COMMENT_DIVISION'),
                                            @CommonFunction.getCoConstDefVal('CD_DTL_COMMENT_IDENTIFICAITON_HIS'))} ]]
                                        </option>
                                        <option th:value="${@CommonFunction.getCoConstDefVal('CD_DTL_COMMENT_PACKAGING_HIS')}">
                                            [[
                                            ${@CoCodeManager.getCodeString(@CommonFunction.getCoConstDefVal('CD_COMMENT_DIVISION'),
                                            @CommonFunction.getCoConstDefVal('CD_DTL_COMMENT_PACKAGING_HIS'))} ]]
                                        </option>
                                        <option th:value="${@CommonFunction.getCoConstDefVal('CD_DTL_COMMENT_DISTRIBUTION_HIS')}">
                                            [[
                                            ${@CoCodeManager.getCodeString(@CommonFunction.getCoConstDefVal('CD_COMMENT_DIVISION'),
                                            @CommonFunction.getCoConstDefVal('CD_DTL_COMMENT_DISTRIBUTION_HIS'))} ]]
                                        </option>
                                    </select>
                                </div>
                                <div class="col-8">
                                    <div class="input-group">
                                        <input class="form-control" type="text" id="schKeyword" name="schKeyword" autocomplete="off">
                                        <div class="input-group-append">
                                            <button class="btn btn-default" id="search" type="button"><i class="fa fa-search"></i></button>
                                        </div>
                                    </div>
                                    <input name="referenceDiv" th:value="${basicInfo.referenceDiv}" type="hidden">
                                    <input name="referenceId" th:value="${basicInfo.referenceId}" type="hidden">
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>
        <section class="content mt-1">
            <div class="container-fluid">
                <div class="card card-lg-red">
                    <div class="card-header">
                        <h3 class="card-title">Comment</h3>
                        <!-- <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse"
                            title="Collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div> -->
                    </div>
                    <div class="card-body pt-0" scroll="auto" style="height: auto">
                        <div class="commentBack" id="commentListArea"><div></div></div>
                    </div>
                </div>
                <div class="btnLayout" id="moreListDiv"
                     style="text-align: center; display: none; padding: 0 0; margin-top: 10px;">
<!--						<span>-->
<!--							<input class="btn btn-outline-secondary btn-lg text-lg mb-3" onclick="fn_comment.getMoreCommentList()" type="button"-->
<!--                                   value="More" style="width: 20%"/>-->
<!--						</span>-->
                    <a class="small-box-footer mb-3" href="#" id="moreInfoBtn" onclick="fn_comment.getMoreCommentList()">More <i
                            class="fas fa-arrow-circle-down"></i></a>
                </div>
            </div>
        </section>
    </div>
    <script th:inline="javascript">
        //<![CDATA[
        /*global $ */
        $(document).ready(function () {
            fn_comment.getCommentList();

            $('#search').on('click', function (e) {
                event.preventDefault();
                fn_comment.getCommentList();
            });

            $('.callOpener').on('click', function (e) {
                try {
                    var paramId = "";

                    if ([[${basicInfo.referenceDiv}]] == 'prj') {
                        paramId = [[${project?.prjId}]];
                    } else if ([[${basicInfo.referenceDiv}]] == '3rd') {
                        paramId = [[${partner?.partnerId}]];
                    }

                    opener.moveTabInFrameByCommentPopup2(paramId, $(this).attr('id'));
                    window.focus();
                } catch (e) {
                }
            });
        });

        const fn_comment = {
            getCommentList: function () {
                $.ajax({
                    url: "/comment/getCommentList",
                    type: 'GET',
                    dataType: 'html',
                    cache: false,
                    data: $('#commentSchForm').serialize(),
                    success: function (res) {
                        $('#commentListArea div').replaceWith(res);
                        $("button[name='commentModifyBtn']").on("click", function (e){
                            e.preventDefault();
                            const commId = $(this).attr("data-commId");
                            fn_comment.handleCommentPopupOpen(commId);
                        });
                        $("button[name='commentDeleteBtn']").on("click", function (e){
                            e.preventDefault();
                            const commId = $(this).attr("data-commId");
                            fn_comment.deleteComment(commId);
                        });
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        alertify.error([[ #{msg.common.valid2}]], 0);
                    }
                });
            },
            deleteComment: function (_commId) {
                if (!confirm(String([[#{msg.oss.confirm.delete.comment}]]))) {
                    return;
                }

                postAjaxData({'commId': _commId}, "/comment/deleteComment", "json", function (data) {
                    alertify.error(String([[ #{msg.common.success}]]));
                    fn_comment.getCommentList();
                }, function () {
                    alertify.error(String([[ #{msg.common.valid2}]]), 0);
                });
            },
            getMoreCommentList: function () {
                $.ajax({
                    url: "/comment/getMoreCommentList",
                    type: 'GET',
                    dataType: 'html',
                    cache: false,
                    data: $('#commentSchForm').serialize(),
                    success: function (data) {
                        $('#commentListArea').append(data);
                    },
                    error: function () {
                        alertify.error([[ #{msg.common.valid2}]], 0);
                    }
                });
            },
            handleCommentPopupOpen: function (_commId)  {
                postAjaxJsonData(JSON.stringify({commId : _commId}), "/comment/getDivCommentByCommId", "html", function (res) {
                    alertify.confirm(res, function (e) {
                        if(e) {
                            fn_comment.editComment();
                        } else {
                            return false;
                        }
                    }).set('resizable', true)
                        .resizeTo('680px', '335px');
                }, null, function () {
                    $("#modifiedCommentEditor").summernote({
                        height: 100,
                        callbacks: {
                            onInit: function() {
                                $(this).summernote('code', contents);
                            }
                        }
                    });
                });
            },
            editComment: function () {
                const commId = $("#modifiedCommentId").val();
                const referenceId = $('input[name=ossId]').val();
                const contents = $('#modifiedCommentEditor').summernote('code');
                const param = {
                    'commId': commId,
                    'contents': contents,
                    'referenceDiv': '40',
                    'referenceId': referenceId
                };

                postAjaxData(param, "/comment/updateComment", "json", function () {
                    alertify.success(String([[ #{msg.common.success}]]), 0);
                }, function () {
                    alertify.error(String([[ #{msg.common.valid2}]]), 0);
                }, function () {
                    fn_comment.getCommentList();
                });
            }
        }
        //]]>
    </script>
</th:block>
<th:block th:fragment="commentPopupFragment">
    <div class="comment-popup">
        <div class="row mt-2">
            <div class="col-12">
                <input type="hidden" id="modifiedCommentId" th:value="${commId}">
                <input type="hidden" id="contents"  th:value="${contents}">
                <textarea class="form-control" id="modifiedCommentEditor" name="commentInput" rows="3" style="height: 800px"></textarea>
            </div>
        </div>
    </div>
</th:block>
<th:block th:fragment="userCommentPopupFragment">
    <div class="comment-popup">
        <div class="row mt-2">
            <div class="col-12">
                <input type="hidden" id="contents"  th:value="${contents}">
                <textarea class="form-control" id="modifiedCommentInPjtEditor" name="commentInput" rows="3" style="margin:0 auto;"></textarea>
                <div class="row">
                    <div class="col-12 my-2">
                        <input type="button" value="Save draft" class="btn btn-default btn-sm float-right" onclick="fn.saveEditor();"/>
                        <input type="button" value="Save & Send comment" class="btn btn-info btn-sm float-right mx-1" onclick="fn.sendEditor('WR');"/>
                    </div>
                </div>
            </div>
        </div>
    </div>
</th:block>
</html>
