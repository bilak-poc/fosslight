<!DOCTYPE HTML>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="fragments/header :: headFragment"></th:block>
<th:block th:replace="fragments/default-script :: scriptFragment"></th:block>

<link href="https://cdnjs.cloudflare.com/ajax/libs/icheck-bootstrap/3.0.1/icheck-bootstrap.min.css" rel="stylesheet">
<body class="hold-transition login-page custom-layout">
<div class="login-box">
    <div class="login-logo">
        <a class="brand-link" href="./index.html" style="font-size:2.25rem;">
            <img alt="FOSSLight hub Logo" class="brand-image img-circle" src="/images/logo_s.png"
                 style="opacity: .5;max-height:50px;"><b>FOSSLight</b>&nbsp;&nbsp;Hub</a>
    </div>
    <div class="card">
        <div class="card-body mx-3" id="authenticationAreaFragment">
            <div class="replaceable-content"></div>
        </div>
    </div>
</div>

</body>
<script>
    $(window).load(function () {
        login_fn.renderPage();
    });

    /* login page */
    const login_fn = {
        renderPage: function () {
            const data = {
                category: "session/fragments",
                templateName: "authentication-fragments",
                fragmentName: "loignFragment"
            };

            postAjaxJsonData(JSON.stringify(data), "/render/component", 'html', function (res) {
                $("#authenticationAreaFragment .replaceable-content").replaceWith(res);
                login_fn.setSaveIdChecked();
            });
        },
        excSubmit: function () {
            formAjaxData("#loginForm", "/session/login-proc",
                function (res) {
                    if ("false" == res.isValid) {
                        alertify.error(res.validMsg, 0);
                    } else {
                        location.href = "/index?lang=" + res.resultData.locale;
                        return;
                    }
                }, onError);
        },
        setSaveIdChecked() {
            const userInputId = getCookie("userInputId");
            $("input[name=userId]").val(userInputId);

            if ($("input[name=un]").val() != "") {
                $("#saveID").attr("checked", true);
            }
        },
        handleSaveIdCheckboxChange(checkbox) {
            if (checkbox.checked) {
                const _userInputId = $("input[name=un]").val();

                setCookie("userInputId", _userInputId, 7);
            } else {
                deleteCookie("userInputId");
            }
        },
        handleSaveIdInputKeyUp() {
            if($("#saveID").is(":checked")){
                const _userInputId= $("input[name=un]").val();
                setCookie("userInputId", _userInputId, 180);
            }
        }
    };

    /* signup page */
    const signup_fn = {
        renderPage: function () {
            const data = {
                category: "session/fragments",
                templateName: "authentication-fragments",
                fragmentName: "signUpFragment"
            };

            postAjaxJsonData(JSON.stringify(data), "/render/component", 'html', function (res) {
                $("#authenticationAreaFragment .replaceable-content").replaceWith(res);
            });
        },
        excSubmit: function () {
            const dFlag = "[[ ${@CoCodeManager.getCodeExpString(@CommonFunction.getCoConstDefVal('CD_REGIST_DOMAIN'), @CommonFunction.getCoConstDefVal('CD_DTL_DEFAULT_DOMAIN'))} ]]";

            if(dFlag) {
                const domain = $("#emailTemp").val();
                const userId = $("input[name=userId]").val();

                if(userId != ""){
                    $("#email").val(userId+"@"+domain);
                }
            } else {
                $("#email").val($("#emailTemp").val());
            }

            formAjaxData("#signupForm", "/system/user/saveAjax", signup_fn.onRegistSuccess);
        },
        onRegistSuccess: function(json, status) {
            hideErrMsg();

            if ("false" == json.isValid) {
                alertify.error('[[ #{msg.common.valid} ]]', 0);

                $('.retxt').text('');

                showErrMsg();

                if (json.userId) {
                    $('.userId').text(json.userId);
                }

                if (json.userPw) {
                    $('.userPw').text(json.userPw);
                }

                if (json.email) {
                    $('.email').text(json.email);
                }

                if (json.division) {
                    $('.division').text(json.division);
                }

                if (json.userName) {
                    $('.userName').text(json.userName);
                }
            } else {
                alertify.alert(String('[[ #{msg.common.success} ]]'), function () {
                    location.reload();
                });
            }
        },
        cancelWithBack: function () {
            login_fn.renderPage();
        },
        emailChange(){
            const value = $("#emailSelect option:selected").val();
            const text = $("#emailSelect option:selected").text();
            const etcDomain = '[[ ${@CommonFunction.getCoConstDefVal("CD_DTL_ECT_DOMAIN")} ]]';

            if(value == etcDomain){
                $("#directEmailInput").val("").show();
            } else {
                $("#directEmailInput").val(text).hide();
            }
        }
    }

    /* reset password page */
    const resetPw_fn = {
        renderPage: function () {
            const data = {
                category: "session/fragments",
                templateName: "authentication-fragments",
                fragmentName: "resetPasswordFragment"
            };

            postAjaxJsonData(JSON.stringify(data), "/render/component", 'html',
                function (res) {
                    $("#authenticationAreaFragment .replaceable-content").replaceWith(res);
                });
        },
        excSubmit: function () {
            if(resetPw_fn.validResetPassword()) {
                const _param = {
                    'userId' : $('#resetPwdForm #userId').val(),
                    'email' : $('#resetPwdForm #email').val()
                }
                postAjaxJsonData(JSON.stringify(_param), "/system/user/resetPassword", "json", resetPw_fn.onResetPasswordSuccess, onError);
            }
        },
        validResetPassword() {
            if ($('#resetPwdForm #userId').isValueEmpty()) {
                $('#resetPwdForm #userIdRequired').show();
                return false;
            }

            if ($('#resetPwdForm #email').isValueEmpty()) {
                $('#resetPwdForm #emailRequired').show();
                return false;
            }

            return true;
        },
        cancelWithBack: function () {
            login_fn.renderPage();
        },
        onResetPasswordSuccess: function (data, status) {
            if (data.resCd == '10') {
                alertify.alert(String('[[ #{msg.login.resetPassword.success} ]]'), function () {
                    location.reload();
                });
            } else if (data.resCd == '21') {
                alertify.alert(String('[[ #{msg.login.resetPassword.failureToFindUser} ]]'), function () {
                    location.reload();
                });
            } else {
                alertify.alert(String('[[ #{msg.common.valid2} ]]'), function () {
                    location.reload();
                });
            }
        }
    }



</script>
</html>